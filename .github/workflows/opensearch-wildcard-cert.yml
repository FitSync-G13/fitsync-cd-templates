name: OpenSearch Wildcard Certificate Setup

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
    secrets:
      AWS_ROLE_ARN:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  create-wildcard-cert:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-WildcardCert

    - name: Create Cloudflare API key secret and ClusterIssuer
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating Cloudflare API key secret and ClusterIssuer..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo 'Creating Cloudflare API key secret...'\",
            \"sudo k3s kubectl create secret generic cloudflare-api-key --from-literal=api-key='${{ secrets.CLOUDFLARE_API_TOKEN }}' -n cert-manager --dry-run=client -o yaml | sudo k3s kubectl apply -f -\",
            \"echo 'Creating ClusterIssuer...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: cert-manager.io/v1\",
            \"kind: ClusterIssuer\",
            \"metadata:\",
            \"  name: letsencrypt-prod\",
            \"spec:\",
            \"  acme:\",
            \"    server: https://acme-v02.api.letsencrypt.org/directory\",
            \"    email: ${{ vars.CERT_EMAIL || 'admin@fitsync.online' }}\",
            \"    privateKeySecretRef:\",
            \"      name: letsencrypt-prod\",
            \"    solvers:\",
            \"    - dns01:\",
            \"        cloudflare:\",
            \"          email: ${{ vars.CERT_EMAIL || 'admin@fitsync.online' }}\",
            \"          apiKeySecretRef:\",
            \"            name: cloudflare-api-key\",
            \"            key: api-key\",
            \"EOF\",
            \"echo 'ClusterIssuer created successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Create wildcard certificates
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating wildcard certificates for OpenSearch..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 900 \
          --parameters "commands=[
            \"echo 'Creating wildcard certificate for internal OpenSearch...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: cert-manager.io/v1\",
            \"kind: Certificate\",
            \"metadata:\",
            \"  name: opensearch-wildcard-cert\",
            \"  namespace: default\",
            \"spec:\",
            \"  secretName: opensearch-wildcard-tls\",
            \"  issuerRef:\",
            \"    name: letsencrypt-prod\",
            \"    kind: ClusterIssuer\",
            \"  dnsNames:\",
            \"  - '${{ vars.OPENSEARCH_SUBDOMAIN }}'\",
            \"---\",
            \"apiVersion: cert-manager.io/v1\",
            \"kind: Certificate\",
            \"metadata:\",
            \"  name: opensearch-dashboard-public-cert\",
            \"  namespace: default\",
            \"spec:\",
            \"  secretName: opensearch-dashboard-public-tls\",
            \"  issuerRef:\",
            \"    name: letsencrypt-prod\",
            \"    kind: ClusterIssuer\",
            \"  dnsNames:\",
            \"  - '${{ vars.OPENSEARCH_DASHBOARD_FQDN }}'\",
            \"EOF\",
            \"echo 'Checking certificate status...'\",
            \"for i in \\$(seq 1 60); do CERT1_STATUS=\\$(sudo k3s kubectl get certificate opensearch-wildcard-cert -o jsonpath='{.status.conditions[?(@.type==\\\"Ready\\\")].status}' 2>/dev/null || echo 'False'); CERT2_STATUS=\\$(sudo k3s kubectl get certificate opensearch-dashboard-public-cert -o jsonpath='{.status.conditions[?(@.type==\\\"Ready\\\")].status}' 2>/dev/null || echo 'False'); echo \\\"Attempt \\$i: opensearch-wildcard-cert=\\$CERT1_STATUS, opensearch-dashboard-public-cert=\\$CERT2_STATUS\\\"; if [ \\\"\\$CERT1_STATUS\\\" = \\\"True\\\" ] && [ \\\"\\$CERT2_STATUS\\\" = \\\"True\\\" ]; then echo 'Both certificates are ready!'; break; fi; sleep 10; done\",
            \"echo 'Final certificate status:'\",
            \"sudo k3s kubectl get certificate\",
            \"echo 'Certificates created successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

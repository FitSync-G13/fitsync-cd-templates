name: OpenSearch Services Expose

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  expose-opensearch:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-Expose

    - name: Create NodePort Services and IngressRoutes
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating NodePort Services and IngressRoutes for OpenSearch..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo 'Creating NodePort Services and IngressRoutes...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: v1\",
            \"kind: Service\",
            \"metadata:\",
            \"  name: opensearch-dashboard-public\",
            \"  namespace: default\",
            \"spec:\",
            \"  type: NodePort\",
            \"  ports:\",
            \"  - name: https\",
            \"    port: 5601\",
            \"    targetPort: 5601\",
            \"    nodePort: 30601\",
            \"    protocol: TCP\",
            \"  selector:\",
            \"    opster.io/opensearch-cluster: opensearch-cluster\",
            \"    opensearch.role: dashboards\",
            \"---\",
            \"apiVersion: v1\",
            \"kind: Service\",
            \"metadata:\",
            \"  name: opensearch-service-public\",
            \"  namespace: default\",
            \"spec:\",
            \"  type: NodePort\",
            \"  ports:\",
            \"  - name: https\",
            \"    port: 9200\",
            \"    targetPort: 9200\",
            \"    nodePort: 30920\",
            \"    protocol: TCP\",
            \"  selector:\",
            \"    opster.io/opensearch-cluster: opensearch-cluster\",
            \"    opensearch.role: masters\",
            \"---\",
            \"apiVersion: traefik.containo.us/v1alpha1\",
            \"kind: IngressRoute\",
            \"metadata:\",
            \"  name: opensearch-ingress\",
            \"  namespace: default\",
            \"spec:\",
            \"  entryPoints:\",
            \"  - websecure\",
            \"  routes:\",
            \"  - match: Host(\\\`${{ vars.OPENSEARCH_SUBDOMAIN }}\\\`)\",
            \"    kind: Rule\",
            \"    services:\",
            \"    - name: opensearch-cluster\",
            \"      port: 9200\",
            \"  tls:\",
            \"    secretName: opensearch-wildcard-tls\",
            \"---\",
            \"apiVersion: traefik.containo.us/v1alpha1\",
            \"kind: IngressRoute\",
            \"metadata:\",
            \"  name: opensearch-service-private-ingress\",
            \"  namespace: default\",
            \"spec:\",
            \"  entryPoints:\",
            \"  - websecure\",
            \"  routes:\",
            \"  - match: Host(\\\`${{ vars.OPENSEARCH_SUBDOMAIN }}\\\`)\",
            \"    kind: Rule\",
            \"    services:\",
            \"    - name: opensearch-service-public\",
            \"      port: 9200\",
            \"  tls:\",
            \"    secretName: opensearch-wildcard-tls\",
            \"---\",
            \"apiVersion: traefik.containo.us/v1alpha1\",
            \"kind: IngressRoute\",
            \"metadata:\",
            \"  name: opensearch-dashboard-public-ingress\",
            \"  namespace: default\",
            \"spec:\",
            \"  entryPoints:\",
            \"  - websecure\",
            \"  routes:\",
            \"  - match: Host(\\\`${{ vars.OPENSEARCH_DASHBOARD_FQDN }}\\\`)\",
            \"    kind: Rule\",
            \"    services:\",
            \"    - name: opensearch-dashboard-public\",
            \"      port: 5601\",
            \"  tls:\",
            \"    secretName: opensearch-dashboard-public-tls\",
            \"EOF\",
            \"echo 'Services and IngressRoutes created successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Verify OpenSearch deployment
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying OpenSearch deployment..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo \"OpenSearch Cluster Status:\"",
            "sudo k3s kubectl get opensearchcluster -o wide",
            "echo \"OpenSearch Pods:\"",
            "sudo k3s kubectl get pods -l opster.io/opensearch-cluster=opensearch-cluster",
            "echo \"OpenSearch Services:\"",
            "sudo k3s kubectl get svc -l opster.io/opensearch-cluster=opensearch-cluster",
            "echo \"NodePort Services:\"",
            "sudo k3s kubectl get svc opensearch-dashboard-public opensearch-service-public",
            "echo \"IngressRoutes:\"",
            "sudo k3s kubectl get ingressroute",
            "echo \"Certificates:\"",
            "sudo k3s kubectl get certificate"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

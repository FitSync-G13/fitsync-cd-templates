name: Trigger Deployment Update

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Name of the service to update'
        required: true
        type: string
      image_tag:
        description: 'New image tag to deploy'
        required: true
        type: string
      environment:
        description: 'Target environment (development/production)'
        required: true
        type: string
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  update-deployment:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Deploy-Update

    - name: Get infrastructure information
      id: get-instances
      run: |
        echo "Getting FitSync infrastructure information for environment: ${{ inputs.environment }}"
        
        # Map GitHub environment to infrastructure environment
        if [ "${{ inputs.environment }}" = "development" ]; then
          INFRA_ENV="dev"
        elif [ "${{ inputs.environment }}" = "production" ]; then
          INFRA_ENV="prod"
        else
          INFRA_ENV="${{ inputs.environment }}"
        fi
        
        echo "Mapped environment: ${{ inputs.environment }} -> $INFRA_ENV"
        
        # Get master instances using the same logic as fitsync-cd
        MASTERS=$(aws ec2 describe-instances \
          --filters "Name=tag:Project,Values=${{ vars.PROJECT_NAME || 'fitsync' }}" "Name=tag:Role,Values=k3s-master" "Name=tag:Env,Values=$INFRA_ENV" "Name=instance-state-name,Values=running" \
          --query 'Reservations[].Instances[].InstanceId' \
          --output text | tr '\t' ',')
        
        echo "master_instances=${MASTERS%,}" >> $GITHUB_OUTPUT
        echo "Found masters: ${MASTERS%,}"
        
        if [ -z "${MASTERS%,}" ]; then
          echo "âŒ No master instances found. Trying alternative tag combinations..."
          
          # Try with different project name variations
          for PROJECT in "fitsync" "FitSync" "${{ vars.PROJECT_NAME }}"; do
            for ENV in "$INFRA_ENV" "${{ inputs.environment }}" "development" "dev"; do
              echo "Trying Project=$PROJECT, Env=$ENV"
              MASTERS=$(aws ec2 describe-instances \
                --filters "Name=tag:Project,Values=$PROJECT" "Name=tag:Role,Values=k3s-master" "Name=tag:Env,Values=$ENV" "Name=instance-state-name,Values=running" \
                --query 'Reservations[].Instances[].InstanceId' \
                --output text | tr '\t' ',')
              
              if [ -n "${MASTERS%,}" ]; then
                echo "âœ… Found masters with Project=$PROJECT, Env=$ENV: ${MASTERS%,}"
                echo "master_instances=${MASTERS%,}" >> $GITHUB_OUTPUT
                break 2
              fi
            done
          done
        fi

    - name: Update deployment with new image tag
      run: |
        MASTER_INSTANCES="${{ steps.get-instances.outputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        if [ -z "$FIRST_MASTER" ]; then
          echo "âŒ No master instances found for environment: ${{ inputs.environment }}"
          echo "Please check that the K3s cluster is running and properly tagged."
          exit 1
        fi
        
        echo "ðŸš€ Updating ${{ inputs.service_name }} deployment with image tag: ${{ inputs.image_tag }}"
        echo "Using master instance: $FIRST_MASTER"
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"export KUBECONFIG=/etc/rancher/k3s/k3s.yaml\",
            \"echo 'ðŸ“‹ Current deployment status:'\",
            \"kubectl get deployment ${{ inputs.service_name }} -n default -o wide || echo 'Deployment not found'\",
            \"echo 'ðŸ”„ Updating deployment with new image tag...'\",
            \"kubectl set image deployment/${{ inputs.service_name }} ${{ inputs.service_name }}=074094370475.dkr.ecr.us-east-2.amazonaws.com/fitsync-${{ inputs.service_name }}:${{ inputs.image_tag }} -n default\",
            \"echo 'â³ Waiting for rollout to complete...'\",
            \"kubectl rollout status deployment/${{ inputs.service_name }} -n default --timeout=300s\",
            \"echo 'ðŸ“‹ Updated deployment status:'\",
            \"kubectl get deployment ${{ inputs.service_name }} -n default -o wide\",
            \"kubectl get pods -l app=${{ inputs.service_name }} -n default\",
            \"echo 'âœ… Deployment update completed successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Waiting for deployment update..."
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --cli-read-timeout 300
        
        # Get command output
        OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text)
        
        echo "$OUTPUT"
        
        # Check if command was successful
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        if [ "$STATUS" != "Success" ]; then
          echo "âŒ Deployment update failed"
          ERROR_OUTPUT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$FIRST_MASTER" \
            --query 'StandardErrorContent' \
            --output text)
          echo "Error output: $ERROR_OUTPUT"
          exit 1
        fi
        
        echo "âœ… Successfully updated ${{ inputs.service_name }} deployment with image tag: ${{ inputs.image_tag }}"

    - name: Verify deployment health
      run: |
        MASTER_INSTANCES="${{ steps.get-instances.outputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "ðŸ” Verifying deployment health..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 120 \
          --parameters "commands=[
            \"export KUBECONFIG=/etc/rancher/k3s/k3s.yaml\",
            \"echo 'ðŸ¥ Health check for ${{ inputs.service_name }}:'\",
            \"kubectl get deployment ${{ inputs.service_name }} -n default\",
            \"echo 'ðŸ“Š Pod status:'\",
            \"kubectl get pods -l app=${{ inputs.service_name }} -n default\",
            \"echo 'ðŸ” Checking pod readiness...'\",
            \"kubectl wait --for=condition=ready pod -l app=${{ inputs.service_name }} -n default --timeout=60s || echo 'Warning: Some pods may not be ready yet'\",
            \"echo 'ðŸ“ˆ Recent events:'\",
            \"kubectl get events --sort-by=.metadata.creationTimestamp -n default | grep ${{ inputs.service_name }} | tail -5 || echo 'No recent events found'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --cli-read-timeout 120
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Deployment Summary
      run: |
        echo "### âœ… Deployment Update Completed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Service:** \`${{ inputs.service_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**New Image Tag:** \`${{ inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Namespace:** \`default\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The deployment has been updated with the new image and a rollout restart has been performed." >> $GITHUB_STEP_SUMMARY

name: Istio Sample App Deployment

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      domain_name:
        description: 'Domain name (empty for no TLS)'
        required: false
        type: string
        default: ''
      subdomain_prefix:
        description: 'Environment subdomain (empty for prod)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-sample-app:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Istio-SampleApp

    - name: Deploy Bookinfo Sample Application
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        DOMAIN_NAME="${{ inputs.domain_name }}"
        SUBDOMAIN_PREFIX="${{ inputs.subdomain_prefix }}"
        
        # Use ALB DNS for VirtualService host (ALB sends requests with its own DNS name)
        ALB_DNS="${{ vars.ALB_DNS_NAME }}"
        
        if [ -n "$DOMAIN_NAME" ]; then
          if [ -z "$SUBDOMAIN_PREFIX" ]; then
            ENV_NAME="${{ inputs.environment }}"
            GATEWAY_NAME="${ENV_NAME}-gateway"
          else
            GATEWAY_NAME="$SUBDOMAIN_PREFIX-gateway"
          fi
        else
          ENV_NAME="${{ inputs.environment }}"
          GATEWAY_NAME="${ENV_NAME}-gateway"
        fi
        
        echo "Deploying Bookinfo sample app"
        echo "Gateway: $GATEWAY_NAME"
        echo "Host: $ALB_DNS"
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters "commands=[
            \"echo Deploying Bookinfo application...\",
            \"bash -c 'cd /tmp/istio-* && sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml'\",
            \"echo Waiting for pods...\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=productpage --timeout=300s\",
            \"echo Applying VirtualService for host ${HOST}...\",
            \"echo apiVersion: networking.istio.io/v1beta1 > /tmp/bookinfo-vs.yaml\",
            \"echo kind: VirtualService >> /tmp/bookinfo-vs.yaml\",
            \"echo metadata: >> /tmp/bookinfo-vs.yaml\",
            \"echo '  name: bookinfo' >> /tmp/bookinfo-vs.yaml\",
            \"echo spec: >> /tmp/bookinfo-vs.yaml\",
            \"echo '  hosts:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '  - \\\"${ALB_DNS}\\\"' >> /tmp/bookinfo-vs.yaml\",
            \"echo '  gateways:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '  - istio-system/${GATEWAY_NAME}' >> /tmp/bookinfo-vs.yaml\",
            \"echo '  http:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '  - match:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - uri:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        exact: /' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    rewrite:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '      uri: /productpage' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    route:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - destination:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        host: productpage' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        port:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '          number: 9080' >> /tmp/bookinfo-vs.yaml\",
            \"echo '  - match:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - uri:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        exact: /productpage' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - uri:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        prefix: /static' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - uri:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        exact: /login' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - uri:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        exact: /logout' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - uri:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        prefix: /api/v1/products' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    route:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '    - destination:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        host: productpage' >> /tmp/bookinfo-vs.yaml\",
            \"echo '        port:' >> /tmp/bookinfo-vs.yaml\",
            \"echo '          number: 9080' >> /tmp/bookinfo-vs.yaml\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f /tmp/bookinfo-vs.yaml\",
            \"rm /tmp/bookinfo-vs.yaml\",
            \"echo Applying destination rules...\",
            \"bash -c 'cd /tmp/istio-* && sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml'\",
            \"echo Deployment completed\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        sleep 30
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Configure mTLS
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Configuring mTLS STRICT mode..."
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo apiVersion: security.istio.io/v1beta1 > /tmp/mtls.yaml",
            "echo kind: PeerAuthentication >> /tmp/mtls.yaml",
            "echo metadata: >> /tmp/mtls.yaml",
            "echo \"  name: default\" >> /tmp/mtls.yaml",
            "echo \"  namespace: default\" >> /tmp/mtls.yaml",
            "echo spec: >> /tmp/mtls.yaml",
            "echo \"  mtls:\" >> /tmp/mtls.yaml",
            "echo \"    mode: STRICT\" >> /tmp/mtls.yaml",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f /tmp/mtls.yaml",
            "rm /tmp/mtls.yaml",
            "echo Restarting pods...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=productpage",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=details",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=ratings",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=reviews",
            "sleep 30",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=productpage --timeout=120s",
            "echo mTLS configured"
          ]' \
          --output text
        
        sleep 20
        echo "mTLS configuration completed"

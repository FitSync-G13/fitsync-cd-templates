name: Istio Sample App Deployment

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-sample-app:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Istio-SampleApp

    - name: Deploy Bookinfo Sample Application
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Deploying Bookinfo sample app on cluster ${{ inputs.cluster_name }}"
        echo "Using master instance: $FIRST_MASTER"
        
        # Deploy sample app
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo Deploying Bookinfo sample application...",
            "bash -c \"cd /tmp/istio-* && sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\"",
            "echo Waiting for pods to be ready...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=productpage --timeout=300s",
            "echo Creating Bookinfo gateway with correct port...",
            "echo apiVersion: networking.istio.io/v1 > /tmp/bookinfo-gateway.yaml",
            "echo kind: Gateway >> /tmp/bookinfo-gateway.yaml",
            "echo metadata: >> /tmp/bookinfo-gateway.yaml",
            "echo \"  name: bookinfo-gateway\" >> /tmp/bookinfo-gateway.yaml",
            "echo spec: >> /tmp/bookinfo-gateway.yaml",
            "echo \"  selector:\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"    istio: ingressgateway\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"  servers:\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"  - port:\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"      number: 80\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"      name: http\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"      protocol: HTTP\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"    hosts:\" >> /tmp/bookinfo-gateway.yaml",
            "echo \"    - \\\"*\\\"\" >> /tmp/bookinfo-gateway.yaml",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f /tmp/bookinfo-gateway.yaml",
            "rm /tmp/bookinfo-gateway.yaml",
            "echo Applying virtual service...",
            "bash -c \"cd /tmp/istio-* && sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml | grep -v Gateway\"",
            "echo Applying destination rules...",
            "bash -c \"cd /tmp/istio-* && sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml\"",
            "echo Sample app deployment completed"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for deployment to complete (max 10 minutes)..."
        
        # Poll for command completion
        MAX_ATTEMPTS=60
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get the final output
        echo "Getting command output..."
        STATUS_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        STDOUT_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text)
        
        echo "Final Status: $STATUS_OUTPUT"
        echo "Output:"
        echo "$STDOUT_OUTPUT"
        
        if [ "$STATUS_OUTPUT" = "Success" ]; then
          echo "Sample app deployment completed successfully"
        else
          echo "Sample app deployment failed with status: $STATUS_OUTPUT"
          exit 1
        fi

    - name: Configure mTLS
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Configuring mTLS for sample app..."
        
        MTLS_COMMAND=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo Configuring mTLS with STRICT mode...",
            "cat <<EOF | sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f -\napiVersion: security.istio.io/v1beta1\nkind: PeerAuthentication\nmetadata:\n  name: default\n  namespace: default\nspec:\n  mtls:\n    mode: STRICT\nEOF",
            "echo Restarting all bookinfo pods to inject sidecars...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=productpage",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=details",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=ratings",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete pods -l app=reviews",
            "echo Waiting for pods to restart with sidecars...",
            "sleep 30",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=productpage --timeout=120s",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=details --timeout=120s",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=ratings --timeout=120s",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=reviews --timeout=120s",
            "echo mTLS configuration and pod restart completed"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "mTLS command ID: $MTLS_COMMAND"
        echo "Waiting for mTLS configuration and pod restart (max 5 minutes)..."
        
        # Poll for command completion
        MAX_ATTEMPTS=30
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$MTLS_COMMAND" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get mTLS configuration output
        echo "mTLS configuration results:"
        aws ssm get-command-invocation \
          --command-id "$MTLS_COMMAND" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "Could not retrieve mTLS output"

    - name: Verify Sample App
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying sample app deployment..."
        
        VERIFY_COMMAND=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo === Application Pods ===",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get pods",
            "echo",
            "echo === Checking Sidecars (should show 2/2 for each pod) ===",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get pods -o jsonpath=\"{range .items[*]}{.metadata.name}{\\\"\\\\t\\\"}{.status.containerStatuses[*].name}{\\\"\\\\n\\\"}{end}\"",
            "echo",
            "echo === Gateway Configuration ===",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get gateway.networking.istio.io bookinfo-gateway -o yaml | grep -A5 port:",
            "echo",
            "echo === Virtual Services ===",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get virtualservice",
            "echo",
            "echo === Ingress Gateway Service ===",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get svc istio-ingressgateway -n istio-system",
            "echo",
            "echo === mTLS Configuration ===",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get peerauthentication",
            "echo",
            "echo Verification completed"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Verify command ID: $VERIFY_COMMAND"
        sleep 15
        
        # Get verification output
        echo "Sample app verification results:"
        aws ssm get-command-invocation \
          --command-id "$VERIFY_COMMAND" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "Could not retrieve verification output"

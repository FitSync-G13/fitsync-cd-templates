name: Wildcard Certificate Setup

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      domain_name:
        description: 'Base domain name (leave empty to use vars.DOMAIN_NAME)'
        required: false
        type: string
        default: ''
      subdomain_prefix:
        description: 'Subdomain prefix (leave empty to use vars.SUBDOMAIN_PREFIX or for prod)'
        required: false
        type: string
        default: ''
      cert_email:
        description: 'Email for Let''s Encrypt (leave empty to use vars.CERT_EMAIL)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  setup-wildcard-cert:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-WildcardCert

    - name: Setup Cloudflare API Token Secret
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating cloudflare-api-token secret..."
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl create namespace istio-system --dry-run=client -o yaml | sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f -\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl delete secret cloudflare-api-token -n istio-system --ignore-not-found\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl create secret generic cloudflare-api-token -n istio-system --from-literal=api-token='${{ secrets.CLOUDFLARE_API_TOKEN }}'\",
            \"echo Secret created\"
          ]" \
          --output text
        
        sleep 10

    - name: Create ClusterIssuer and Certificate
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        # Use input or fall back to vars
        DOMAIN_NAME="${{ inputs.domain_name }}"
        if [ -z "$DOMAIN_NAME" ]; then
          DOMAIN_NAME="${{ vars.DOMAIN_NAME }}"
        fi
        
        CERT_EMAIL="${{ inputs.cert_email }}"
        if [ -z "$CERT_EMAIL" ]; then
          CERT_EMAIL="${{ vars.CERT_EMAIL }}"
        fi
        
        SUBDOMAIN_PREFIX="${{ inputs.subdomain_prefix }}"
        if [ -z "$SUBDOMAIN_PREFIX" ]; then
          SUBDOMAIN_PREFIX="${{ vars.SUBDOMAIN_PREFIX || '' }}"
        fi
        
        # Validate required fields
        if [ -z "$DOMAIN_NAME" ]; then
          echo "Error: domain_name is required but was empty"
          exit 1
        fi
        
        if [ -z "$CERT_EMAIL" ]; then
          echo "Error: cert_email is required but was empty"
          exit 1
        fi
        
        if [ -z "$SUBDOMAIN_PREFIX" ]; then
          WILDCARD_DOMAIN="*.$DOMAIN_NAME"
          ROOT_DOMAIN="$DOMAIN_NAME"
          CERT_NAME="prod-wildcard-cert"
        else
          WILDCARD_DOMAIN="*.$SUBDOMAIN_PREFIX.$DOMAIN_NAME"
          ROOT_DOMAIN="$SUBDOMAIN_PREFIX.$DOMAIN_NAME"
          CERT_NAME="$SUBDOMAIN_PREFIX-wildcard-cert"
        fi
        
        echo "Certificate: $WILDCARD_DOMAIN, $ROOT_DOMAIN"
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters "commands=[
            \"echo Creating ClusterIssuer...\",
            \"echo apiVersion: cert-manager.io/v1 > /tmp/issuer.yaml\",
            \"echo kind: ClusterIssuer >> /tmp/issuer.yaml\",
            \"echo metadata: >> /tmp/issuer.yaml\",
            \"echo '  name: letsencrypt-prod' >> /tmp/issuer.yaml\",
            \"echo spec: >> /tmp/issuer.yaml\",
            \"echo '  acme:' >> /tmp/issuer.yaml\",
            \"echo '    server: https://acme-v02.api.letsencrypt.org/directory' >> /tmp/issuer.yaml\",
            \"echo '    email: ${CERT_EMAIL}' >> /tmp/issuer.yaml\",
            \"echo '    privateKeySecretRef:' >> /tmp/issuer.yaml\",
            \"echo '      name: letsencrypt-prod-key' >> /tmp/issuer.yaml\",
            \"echo '    solvers:' >> /tmp/issuer.yaml\",
            \"echo '    - dns01:' >> /tmp/issuer.yaml\",
            \"echo '        cloudflare:' >> /tmp/issuer.yaml\",
            \"echo '          apiTokenSecretRef:' >> /tmp/issuer.yaml\",
            \"echo '            name: cloudflare-api-token' >> /tmp/issuer.yaml\",
            \"echo '            key: api-token' >> /tmp/issuer.yaml\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f /tmp/issuer.yaml\",
            \"rm /tmp/issuer.yaml\",
            \"echo Creating Certificate...\",
            \"echo apiVersion: cert-manager.io/v1 > /tmp/cert.yaml\",
            \"echo kind: Certificate >> /tmp/cert.yaml\",
            \"echo metadata: >> /tmp/cert.yaml\",
            \"echo '  name: ${CERT_NAME}' >> /tmp/cert.yaml\",
            \"echo '  namespace: istio-system' >> /tmp/cert.yaml\",
            \"echo spec: >> /tmp/cert.yaml\",
            \"echo '  secretName: ${CERT_NAME}' >> /tmp/cert.yaml\",
            \"echo '  issuerRef:' >> /tmp/cert.yaml\",
            \"echo '    name: letsencrypt-prod' >> /tmp/cert.yaml\",
            \"echo '    kind: ClusterIssuer' >> /tmp/cert.yaml\",
            \"echo '  dnsNames:' >> /tmp/cert.yaml\",
            \"echo '  - \\\"${WILDCARD_DOMAIN}\\\"' >> /tmp/cert.yaml\",
            \"echo '  - \\\"${ROOT_DOMAIN}\\\"' >> /tmp/cert.yaml\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f /tmp/cert.yaml\",
            \"rm /tmp/cert.yaml\",
            \"sleep 30\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=Ready certificate/${CERT_NAME} -n istio-system --timeout=300s || echo 'Check manually'\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get certificate ${CERT_NAME} -n istio-system\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        sleep 60
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text
        
        echo "Certificate setup completed"

name: Prometheus & Grafana Install for Cilium Monitoring

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      domain_name:
        description: 'Base domain name for ingress'
        required: false
        type: string
        default: ''
      subdomain_prefix:
        description: 'Subdomain prefix for ingress'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  install-prometheus-grafana:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Prometheus-Grafana-Install

    - name: Install Prometheus and Grafana
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Installing Prometheus and Grafana for Cilium monitoring on cluster ${{ inputs.cluster_name }}"
        echo "Using master instance: $FIRST_MASTER"
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo Installing Prometheus and Grafana for Cilium monitoring...",
            "echo Setting up Helm if not already installed...",
            "if ! command -v helm &> /dev/null; then",
            "  curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3",
            "  chmod 700 get_helm.sh",
            "  ./get_helm.sh",
            "  rm get_helm.sh",
            "fi",
            "echo Applying Cilium monitoring example...",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.18.4/examples/kubernetes/addons/prometheus/monitoring-example.yaml",
            "echo Waiting for pods to be ready...",
            "sleep 30",
            "echo Checking deployment status...",
            "sudo k3s kubectl get pods -n cilium-monitoring",
            "echo Waiting for services to be ready...",
            "sudo k3s kubectl wait --for=condition=ready pod -l app=prometheus -n cilium-monitoring --timeout=300s",
            "sudo k3s kubectl wait --for=condition=ready pod -l app=grafana -n cilium-monitoring --timeout=300s",
            "echo Prometheus and Grafana installation completed successfully"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for installation to complete (max 10 minutes)..."
        
        # Poll for command completion
        MAX_ATTEMPTS=60  # 60 attempts * 10 seconds = 10 minutes
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get the final output
        echo "Getting command output..."
        STATUS_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        STDOUT_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text)
        
        echo "Final Status: $STATUS_OUTPUT"
        echo "Output:"
        echo "$STDOUT_OUTPUT"
        
        if [ "$STATUS_OUTPUT" = "Success" ]; then
          echo "Prometheus and Grafana installation completed successfully"
        else
          echo "Prometheus and Grafana installation failed with status: $STATUS_OUTPUT"
          exit 1
        fi

    - name: Create Istio VirtualServices for Monitoring
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        # Use input or fall back to vars
        DOMAIN_NAME="${{ inputs.domain_name }}"
        if [ -z "$DOMAIN_NAME" ]; then
          DOMAIN_NAME="${{ vars.DOMAIN_NAME }}"
        fi
        
        SUBDOMAIN_PREFIX="${{ inputs.subdomain_prefix }}"
        if [ -z "$SUBDOMAIN_PREFIX" ]; then
          SUBDOMAIN_PREFIX="${{ vars.SUBDOMAIN_PREFIX || '' }}"
        fi
        
        # Gateway name always uses environment
        GATEWAY_NAME="${{ inputs.environment }}-gateway"
        
        if [ -z "$SUBDOMAIN_PREFIX" ]; then
          HOST_PATTERN="*.$DOMAIN_NAME"
        else
          HOST_PATTERN="*.$SUBDOMAIN_PREFIX.$DOMAIN_NAME"
        fi
        
        echo "Creating VirtualServices for monitoring dashboards"
        echo "Gateway: $GATEWAY_NAME"
        echo "Host pattern: $HOST_PATTERN"
        
        VIRTUALSERVICE_COMMAND=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo 'Creating Grafana VirtualService...'\",
            \"cat > /tmp/grafana-virtualservice.yaml << 'EOF'
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: grafana-monitoring
  namespace: cilium-monitoring
spec:
  hosts:
  - \\\"*\\\"
  gateways:
  - istio-system/${GATEWAY_NAME}
  http:
  - match:
    - uri:
        prefix: /grafana
    rewrite:
      uri: /
    route:
    - destination:
        host: grafana.cilium-monitoring.svc.cluster.local
        port:
          number: 3000
EOF\",
            \"sudo k3s kubectl apply -f /tmp/grafana-virtualservice.yaml\",
            \"echo 'Creating Prometheus VirtualService...'\",
            \"cat > /tmp/prometheus-virtualservice.yaml << 'EOF'
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: prometheus-monitoring
  namespace: cilium-monitoring
spec:
  hosts:
  - \\\"*\\\"
  gateways:
  - istio-system/${GATEWAY_NAME}
  http:
  - match:
    - uri:
        prefix: /prometheus
    rewrite:
      uri: /
    route:
    - destination:
        host: prometheus.cilium-monitoring.svc.cluster.local
        port:
          number: 9090
EOF\",
            \"sudo k3s kubectl apply -f /tmp/prometheus-virtualservice.yaml\",
            \"rm /tmp/grafana-virtualservice.yaml /tmp/prometheus-virtualservice.yaml\",
            \"echo 'VirtualServices created successfully'\",
            \"sudo k3s kubectl get virtualservice -n cilium-monitoring\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        echo "VirtualService Command ID: $VIRTUALSERVICE_COMMAND"
        echo "Waiting for VirtualService creation to complete..."
        
        MAX_ATTEMPTS=30
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$VIRTUALSERVICE_COMMAND" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        echo "Getting VirtualService command output..."
        STDOUT_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$VIRTUALSERVICE_COMMAND" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text)
        
        echo "VirtualService Output:"
        echo "$STDOUT_OUTPUT"
        
        if [ "$STATUS" = "Success" ]; then
          echo "VirtualServices created successfully"
        else
          echo "VirtualService creation failed with status: $STATUS"
          exit 1
        fi

    - name: Verify Installation and Access
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying Prometheus and Grafana installation..."
        
        VERIFY_COMMAND=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo \"Checking cilium-monitoring namespace...\"",
            "sudo k3s kubectl get namespace cilium-monitoring",
            "echo \"Checking Prometheus pods...\"",
            "sudo k3s kubectl get pods -n cilium-monitoring -l app=prometheus",
            "echo \"Checking Grafana pods...\"",
            "sudo k3s kubectl get pods -n cilium-monitoring -l app=grafana",
            "echo \"Checking services...\"",
            "sudo k3s kubectl get svc -n cilium-monitoring",
            "echo \"Checking VirtualServices...\"",
            "sudo k3s kubectl get virtualservice -n cilium-monitoring",
            "echo \"Checking if Prometheus is scraping Cilium metrics...\"",
            "sudo k3s kubectl logs -n cilium-monitoring -l app=prometheus --tail=20 | grep -i cilium || echo No Cilium metrics logs found",
            "echo \"Installation verification completed\"",
            "echo \"Access URLs:\"",
            "echo \"Grafana: https://your-domain/grafana\"",
            "echo \"Prometheus: https://your-domain/prometheus\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Verify command ID: $VERIFY_COMMAND"
        echo "Waiting for verification to complete..."
        
        # Poll for verification completion
        MAX_ATTEMPTS=30
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 5
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$VERIFY_COMMAND" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get verification output
        echo "Verification results:"
        aws ssm get-command-invocation \
          --command-id "$VERIFY_COMMAND" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "Could not retrieve verification output"

name: Prometheus & Grafana Install for Cilium Monitoring

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      domain_name:
        description: 'Base domain name for ingress'
        required: false
        type: string
        default: ''
      subdomain_prefix:
        description: 'Subdomain prefix for ingress'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  install-prometheus-grafana:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Prometheus-Grafana-Install

    - name: Install Prometheus and Grafana
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.18.4/examples/kubernetes/addons/prometheus/monitoring-example.yaml",
            "sleep 60",
            "sudo k3s kubectl get pods -n cilium-monitoring"
          ]'
        
        sleep 90
        echo "Prometheus and Grafana installed"

    - name: Configure Grafana for subpath
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo k3s kubectl patch configmap grafana-config -n cilium-monitoring --patch=\"{\\\"data\\\":{\\\"grafana.ini\\\":\\\"[server]\\nroot_url = %(protocol)s://%(domain)s:%(http_port)s/grafana/\\nserve_from_sub_path = true\\n\\\"}}\"",
            "sudo k3s kubectl rollout restart deployment/grafana -n cilium-monitoring",
            "sleep 30"
          ]'

    - name: Create Grafana VirtualService
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        GATEWAY_NAME="${{ inputs.environment }}-gateway"
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo \"apiVersion: networking.istio.io/v1beta1\" > /tmp/grafana-vs.yaml",
            "echo \"kind: VirtualService\" >> /tmp/grafana-vs.yaml",
            "echo \"metadata:\" >> /tmp/grafana-vs.yaml",
            "echo \"  name: grafana-monitoring\" >> /tmp/grafana-vs.yaml",
            "echo \"  namespace: cilium-monitoring\" >> /tmp/grafana-vs.yaml",
            "echo \"spec:\" >> /tmp/grafana-vs.yaml",
            "echo \"  hosts:\" >> /tmp/grafana-vs.yaml",
            "echo \"  - \\\"*\\\"\" >> /tmp/grafana-vs.yaml",
            "echo \"  gateways:\" >> /tmp/grafana-vs.yaml",
            "echo \"  - istio-system/'${GATEWAY_NAME}'\" >> /tmp/grafana-vs.yaml",
            "echo \"  http:\" >> /tmp/grafana-vs.yaml",
            "echo \"  - match:\" >> /tmp/grafana-vs.yaml",
            "echo \"    - uri:\" >> /tmp/grafana-vs.yaml",
            "echo \"        prefix: /grafana\" >> /tmp/grafana-vs.yaml",
            "echo \"    route:\" >> /tmp/grafana-vs.yaml",
            "echo \"    - destination:\" >> /tmp/grafana-vs.yaml",
            "echo \"        host: grafana.cilium-monitoring.svc.cluster.local\" >> /tmp/grafana-vs.yaml",
            "echo \"        port:\" >> /tmp/grafana-vs.yaml",
            "echo \"          number: 3000\" >> /tmp/grafana-vs.yaml",
            "sudo k3s kubectl apply -f /tmp/grafana-vs.yaml",
            "rm /tmp/grafana-vs.yaml"
          ]'

    - name: Create Prometheus VirtualService
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        GATEWAY_NAME="${{ inputs.environment }}-gateway"
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo \"apiVersion: networking.istio.io/v1beta1\" > /tmp/prometheus-vs.yaml",
            "echo \"kind: VirtualService\" >> /tmp/prometheus-vs.yaml",
            "echo \"metadata:\" >> /tmp/prometheus-vs.yaml",
            "echo \"  name: prometheus-monitoring\" >> /tmp/prometheus-vs.yaml",
            "echo \"  namespace: cilium-monitoring\" >> /tmp/prometheus-vs.yaml",
            "echo \"spec:\" >> /tmp/prometheus-vs.yaml",
            "echo \"  hosts:\" >> /tmp/prometheus-vs.yaml",
            "echo \"  - \\\"*\\\"\" >> /tmp/prometheus-vs.yaml",
            "echo \"  gateways:\" >> /tmp/prometheus-vs.yaml",
            "echo \"  - istio-system/'${GATEWAY_NAME}'\" >> /tmp/prometheus-vs.yaml",
            "echo \"  http:\" >> /tmp/prometheus-vs.yaml",
            "echo \"  - match:\" >> /tmp/prometheus-vs.yaml",
            "echo \"    - uri:\" >> /tmp/prometheus-vs.yaml",
            "echo \"        prefix: /prometheus\" >> /tmp/prometheus-vs.yaml",
            "echo \"    route:\" >> /tmp/prometheus-vs.yaml",
            "echo \"    - destination:\" >> /tmp/prometheus-vs.yaml",
            "echo \"        host: prometheus.cilium-monitoring.svc.cluster.local\" >> /tmp/prometheus-vs.yaml",
            "echo \"        port:\" >> /tmp/prometheus-vs.yaml",
            "echo \"          number: 9090\" >> /tmp/prometheus-vs.yaml",
            "sudo k3s kubectl apply -f /tmp/prometheus-vs.yaml",
            "rm /tmp/prometheus-vs.yaml"
          ]'

    - name: Configure Prometheus for subpath
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo k3s kubectl patch configmap prometheus -n cilium-monitoring --patch=\"{\\\"data\\\":{\\\"prometheus.yml\\\":\\\"global:\\n  scrape_interval: 15s\\nrule_files:\\nscrape_configs:\\n- job_name: prometheus\\n  static_configs:\\n  - targets: [localhost:9090]\\n- job_name: cilium-agent\\n  kubernetes_sd_configs:\\n  - role: pod\\n  relabel_configs:\\n  - source_labels: [__meta_kubernetes_pod_label_k8s_app]\\n    action: keep\\n    regex: cilium\\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\\n    action: replace\\n    regex: ([^:]+)(?::\\\\d+)?;(\\\\d+)\\n    replacement: \\${1}:\\${2}\\n    target_label: __address__\\n- job_name: cilium-operator\\n  kubernetes_sd_configs:\\n  - role: pod\\n  relabel_configs:\\n  - source_labels: [__meta_kubernetes_pod_label_name]\\n    action: keep\\n    regex: cilium-operator\\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\\n    action: replace\\n    regex: ([^:]+)(?::\\\\d+)?;(\\\\d+)\\n    replacement: \\${1}:\\${2}\\n    target_label: __address__\\n- job_name: hubble\\n  kubernetes_sd_configs:\\n  - role: pod\\n  relabel_configs:\\n  - source_labels: [__meta_kubernetes_pod_label_k8s_app]\\n    action: keep\\n    regex: hubble\\n  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]\\n    action: replace\\n    regex: ([^:]+)(?::\\\\d+)?;(\\\\d+)\\n    replacement: \\${1}:\\${2}\\n    target_label: __address__\\n\\\"}}\"",
            "sudo k3s kubectl set env deployment/prometheus -n cilium-monitoring --list",
            "sudo k3s kubectl set env deployment/prometheus -n cilium-monitoring PROMETHEUS_WEB_EXTERNAL_URL=/prometheus/",
            "sudo k3s kubectl rollout restart deployment/prometheus -n cilium-monitoring",
            "sleep 30"
          ]'

    - name: Verify Installation
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        sleep 30
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo k3s kubectl get pods -n cilium-monitoring",
            "sudo k3s kubectl get virtualservice -n cilium-monitoring"
          ]'
        
        echo "Installation completed. Access via /grafana and /prometheus"

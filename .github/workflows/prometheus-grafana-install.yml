name: Prometheus & Grafana Install for Cilium Monitoring

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      domain_name:
        description: 'Base domain name for ingress'
        required: false
        type: string
        default: ''
      subdomain_prefix:
        description: 'Subdomain prefix for ingress'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  install-prometheus-grafana:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Prometheus-Grafana-Install

    - name: Install Prometheus and Grafana
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Installing Prometheus and Grafana for Cilium monitoring"
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo Installing Prometheus and Grafana...",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.18.4/examples/kubernetes/addons/prometheus/monitoring-example.yaml",
            "sleep 30",
            "sudo k3s kubectl wait --for=condition=ready pod -l app=prometheus -n cilium-monitoring --timeout=300s",
            "sudo k3s kubectl wait --for=condition=ready pod -l app=grafana -n cilium-monitoring --timeout=300s",
            "echo Installation completed"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Waiting for installation..."
        sleep 60
        
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        echo "Installation status: $STATUS"

    - name: Create VirtualServices
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        GATEWAY_NAME="${{ inputs.environment }}-gateway"
        
        echo "Creating VirtualServices"
        
        VS_COMMAND=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo Creating Grafana VirtualService\",
            \"sudo k3s kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: grafana-monitoring
  namespace: cilium-monitoring
spec:
  hosts:
  - '*'
  gateways:
  - istio-system/$GATEWAY_NAME
  http:
  - match:
    - uri:
        prefix: /grafana
    rewrite:
      uri: /
    route:
    - destination:
        host: grafana.cilium-monitoring.svc.cluster.local
        port:
          number: 3000
EOF\",
            \"echo Creating Prometheus VirtualService\",
            \"sudo k3s kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: prometheus-monitoring
  namespace: cilium-monitoring
spec:
  hosts:
  - '*'
  gateways:
  - istio-system/$GATEWAY_NAME
  http:
  - match:
    - uri:
        prefix: /prometheus
    rewrite:
      uri: /
    route:
    - destination:
        host: prometheus.cilium-monitoring.svc.cluster.local
        port:
          number: 9090
EOF\",
            \"echo VirtualServices created\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Waiting for VirtualServices..."
        sleep 30
        
        VS_STATUS=$(aws ssm get-command-invocation \
          --command-id "$VS_COMMAND" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        echo "VirtualService status: $VS_STATUS"

    - name: Verify Installation
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying installation"
        
        VERIFY_CMD=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo k3s kubectl get pods -n cilium-monitoring",
            "sudo k3s kubectl get svc -n cilium-monitoring",
            "sudo k3s kubectl get virtualservice -n cilium-monitoring"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        sleep 20
        
        aws ssm get-command-invocation \
          --command-id "$VERIFY_CMD" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "Verification completed"

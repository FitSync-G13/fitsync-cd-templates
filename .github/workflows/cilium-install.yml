name: Cilium CNI Install

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      cilium_cli_version:
        description: 'Cilium CLI version (leave empty for latest)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  install-cilium:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Cilium-Install

    - name: Install Cilium CNI
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Installing Cilium CNI on cluster ${{ inputs.cluster_name }}"
        echo "Using master instance: $FIRST_MASTER"
        echo "Cilium CLI version: latest"
        
        # Install Cilium using helm on the first master
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo Installing Cilium CNI...",
            "CLI_ARCH=amd64",
            "if [ $(uname -m) = aarch64 ]; then CLI_ARCH=arm64; fi",
            "echo Detected architecture: $CLI_ARCH",
            "CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)",
            "echo Using Cilium CLI version: $CILIUM_CLI_VERSION",
            "curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}",
            "sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum",
            "sudo tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin",
            "rm -f cilium-linux-${CLI_ARCH}.tar.gz cilium-linux-${CLI_ARCH}.tar.gz.sha256sum",
            "echo Installing Helm...",
            "curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash",
            "echo Adding Cilium Helm repository...",
            "helm repo add cilium https://helm.cilium.io/",
            "helm repo update",
            "echo Installing Cilium with Helm...",
            "helm upgrade --install cilium cilium/cilium --namespace kube-system --set operator.replicas=1 --set ipam.mode=kubernetes --set kubeProxyReplacement=true --set k8sServiceHost=localhost --set k8sServicePort=6443 --kubeconfig /etc/rancher/k3s/k3s.yaml",
            "echo Waiting for Cilium to be ready...",
            "sudo k3s kubectl wait --for=condition=ready pod -l k8s-app=cilium -n kube-system --timeout=600s || echo Cilium pods may still be initializing",
            "echo Cilium installation completed successfully"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for Cilium installation to complete (max 10 minutes)..."
        
        # Poll for command completion with custom timeout
        MAX_ATTEMPTS=60  # 60 attempts * 10 seconds = 10 minutes
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get the final output
        echo "Getting command output..."
        OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query '[Status, StandardOutputContent, StandardErrorContent]' \
          --output text)
        
        FINAL_STATUS=$(echo "$OUTPUT" | head -n1)
        echo "Final Status: $FINAL_STATUS"
        echo "Output:"
        echo "$OUTPUT" | tail -n +2
        
        if [ "$FINAL_STATUS" = "Success" ]; then
          echo "Cilium installation completed successfully"
        else
          echo "Cilium installation failed with status: $FINAL_STATUS"
          exit 1
        fi

    - name: Verify Cilium installation
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying Cilium installation..."
        
        VERIFY_COMMAND=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo \"Checking Cilium pods...\"",
            "sudo k3s kubectl get pods -n kube-system -l k8s-app=cilium -o wide",
            "echo \"Checking Cilium status...\"",
            "cilium status",
            "echo \"Checking cluster connectivity...\"",
            "sudo k3s kubectl get nodes -o wide",
            "echo \"Cilium verification completed\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Verify command ID: $VERIFY_COMMAND"
        echo "Waiting for verification to complete..."
        
        # Poll for verification completion
        MAX_ATTEMPTS=30  # 30 attempts * 5 seconds = 2.5 minutes
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 5
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$VERIFY_COMMAND" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get verification output
        echo "Cilium verification results:"
        aws ssm get-command-invocation \
          --command-id "$VERIFY_COMMAND" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "Could not retrieve verification output"

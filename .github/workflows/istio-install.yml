name: Istio Service Mesh Install

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      istio_version:
        description: 'Istio version (leave empty for latest)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  install-istio:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Istio-Install

    - name: Install Istio
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        ISTIO_VERSION="${{ inputs.istio_version }}"
        
        echo "Installing Istio on cluster ${{ inputs.cluster_name }}"
        echo "Using master instance: $FIRST_MASTER"
        if [ -n "$ISTIO_VERSION" ]; then
          echo "Istio version: $ISTIO_VERSION"
        else
          echo "Istio version: latest"
        fi
        
        # Build version command
        if [ -n "$ISTIO_VERSION" ]; then
          VERSION_CMD="ISTIO_VERSION=$ISTIO_VERSION"
        else
          VERSION_CMD="ISTIO_VERSION=\$(curl -sL https://istio.io/downloadIstio | grep -oP 'ISTIO_VERSION=\K[0-9.]+' | head -1)"
        fi
        
        # Install Istio on the first master
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo Installing Istio...",
            "cd /tmp",
            "'"$VERSION_CMD"'",
            "echo Using Istio version: $ISTIO_VERSION",
            "curl -L https://istio.io/downloadIstio -o install.sh",
            "sh install.sh",
            "bash -c \"cd /tmp/istio-* && sudo cp bin/istioctl /usr/local/bin/\"",
            "echo Checking if Istio is already installed...",
            "if sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get namespace istio-system >/dev/null 2>&1; then echo Istio namespace already exists, skipping installation; exit 0; fi",
            "echo Installing Istio with default profile...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml istioctl install --set profile=default -y",
            "echo Waiting for Istio pods to be ready...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl wait --for=condition=ready pod -l app=istiod -n istio-system --timeout=300s || echo Istio pods may still be starting",
            "echo Configuring ingress gateway as NodePort...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl patch svc istio-ingressgateway -n istio-system -p '"'"'{\"spec\":{\"type\":\"NodePort\",\"ports\":[{\"name\":\"http2\",\"nodePort\":30080,\"port\":80,\"protocol\":\"TCP\",\"targetPort\":8080},{\"name\":\"https\",\"nodePort\":30443,\"port\":443,\"protocol\":\"TCP\",\"targetPort\":8443}]}}'"'"'",
            "echo Labeling default namespace for sidecar injection...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl label namespace default istio-injection=enabled --overwrite",
            "echo Istio installation completed successfully"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for Istio installation to complete (max 10 minutes)..."
        
        # Poll for command completion
        MAX_ATTEMPTS=60
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get the final output
        echo "Getting command output..."
        STATUS_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        STDOUT_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text)
        
        echo "Final Status: $STATUS_OUTPUT"
        echo "Output:"
        echo "$STDOUT_OUTPUT"
        
        if [ "$STATUS_OUTPUT" = "Success" ]; then
          echo "Istio installation completed successfully"
        else
          echo "Istio installation failed with status: $STATUS_OUTPUT"
          exit 1
        fi

    - name: Verify Istio installation
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying Istio installation..."
        
        VERIFY_COMMAND=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo Checking Istio pods...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get pods -n istio-system",
            "echo Checking Istio version...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml istioctl version",
            "echo Istio verification completed"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Verify command ID: $VERIFY_COMMAND"
        echo "Waiting for verification to complete..."
        
        # Poll for verification completion
        MAX_ATTEMPTS=30
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 5
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$VERIFY_COMMAND" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        # Get verification output
        echo "Istio verification results:"
        aws ssm get-command-invocation \
          --command-id "$VERIFY_COMMAND" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "Could not retrieve verification output"

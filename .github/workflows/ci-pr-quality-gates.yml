name: "PR Quality Gates"

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Name of the service'
        required: true
        type: string
      ecr_repository:
        description: 'Name of the ECR repository'
        required: true
        type: string
      language:
        description: 'Runtime language (node/python)'
        required: false
        default: 'node'
        type: string
      node_version:
        description: 'Node.js version'
        required: false
        default: '18'
        type: string
      python_version:
        description: 'Python version'
        required: false
        default: '3.11'
        type: string
      install_command:
        description: 'Command to install dependencies'
        required: false
        type: string
        default: ''
      test_command:
        description: 'Command to run tests'
        required: false
        type: string
        default: ''
      lint_command:
        description: 'Command to run linting'
        required: false
        type: string
        default: ''
      run_e2e_tests:
        description: 'Run E2E tests (only for main branch PRs)'
        required: false
        type: boolean
        default: false
      skip_security_scan:
        description: 'Skip security scanning (for emergency hotfixes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: write
  security-events: write
  checks: write

env:
  ECR_REGISTRY: ${{ vars.ECR_REGISTRY }}

jobs:
  tests-and-quality:
    name: Tests & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        if: inputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
      
      - name: Setup Python
        if: inputs.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
      
      - name: Install Dependencies (Node.js)
        if: inputs.language == 'node'
        run: |
          INSTALL_CMD="${{ inputs.install_command }}"
          if [ -z "$INSTALL_CMD" ]; then INSTALL_CMD="npm ci"; fi
          echo "Installing with: $INSTALL_CMD"
          $INSTALL_CMD
      
      - name: Install Dependencies (Python)
        if: inputs.language == 'python'
        run: |
          INSTALL_CMD="${{ inputs.install_command }}"
          if [ -z "$INSTALL_CMD" ]; then INSTALL_CMD="pip install -r requirements.txt"; fi
          echo "Installing with: $INSTALL_CMD"
          $INSTALL_CMD
      
      - name: Run Linting (Node.js)
        if: inputs.language == 'node'
        run: |
          LINT_CMD="${{ inputs.lint_command }}"
          if [ -z "$LINT_CMD" ]; then LINT_CMD="npm run lint"; fi
          echo "Linting with: $LINT_CMD"
          $LINT_CMD || echo "No lint script found, skipping"
      
      - name: Run Linting (Python)
        if: inputs.language == 'python'
        run: |
          LINT_CMD="${{ inputs.lint_command }}"
          if [ -z "$LINT_CMD" ]; then LINT_CMD="flake8 ."; fi
          echo "Linting with: $LINT_CMD"
          $LINT_CMD || echo "No flake8 found, skipping"
      
      - name: Run Unit Tests
        run: |
          TEST_CMD="${{ inputs.test_command }}"
          if [ -z "$TEST_CMD" ]; then
            if [ "${{ inputs.language }}" = "node" ]; then
              TEST_CMD="npm test"
            else
              TEST_CMD="pytest tests/"
            fi
          fi
          echo "Testing with: $TEST_CMD"
          $TEST_CMD
        env:
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          REDIS_HOST: "localhost"
          JWT_SECRET: "test-secret"
      
      - name: Generate Coverage Report
        if: inputs.language == 'node'
        continue-on-error: true
        run: npm test -- --coverage || echo "Coverage not configured"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_security_scan }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        if: inputs.language == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: 'npm'
      
      - name: Setup Python
        if: inputs.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
      
      - name: Install Dependencies
        run: |
          if [ "${{ inputs.language }}" = "node" ]; then
            npm ci
          else
            pip install -r requirements.txt
          fi
      
      - name: Run Dependency Audit (Node.js)
        if: inputs.language == 'node'
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate || true
          echo ""
          echo "Checking for CRITICAL vulnerabilities only..."
          npm audit --audit-level=critical
      
      - name: Run Dependency Audit (Python)
        if: inputs.language == 'python'
        run: |
          echo "Installing safety..."
          pip install safety
          echo "Running safety check..."
          safety check --json || true
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Image for Security Scan
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: pr-security-scan:${{ github.event.pull_request.number }}
          cache-from: type=gha
      
      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.0
        with:
          version: 'v0.58.1'
      
      - name: Run Trivy Scan (Console)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'pr-security-scan:${{ github.event.pull_request.number }}'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'
          skip-setup-trivy: true
      
      - name: Run Trivy Scan (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: 'pr-security-scan:${{ github.event.pull_request.number }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          skip-setup-trivy: true
      
      - name: Upload Security Results
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
      
      - name: Block on Critical Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'pr-security-scan:${{ github.event.pull_request.number }}'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL'
          ignore-unfixed: true
          skip-setup-trivy: true
      
      - name: Cleanup
        if: always()
        run: docker rmi pr-security-scan:${{ github.event.pull_request.number }} || true

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: pr-build-verify:${{ github.event.pull_request.number }}
          cache-from: type=gha
      
      - name: Test Container Startup
        run: |
          echo "Starting container..."
          docker run -d --name test-container \
            -e DATABASE_URL="postgresql://dummy:dummy@localhost:5432/dummy" \
            -e REDIS_HOST="localhost" \
            -e JWT_SECRET="test-secret-key" \
            -e NODE_ENV="test" \
            pr-build-verify:${{ github.event.pull_request.number }}
          
          echo "Waiting for container to initialize..."
          sleep 10
          
          # Check if container is running
          if [ "$(docker inspect -f '{{.State.Running}}' test-container)" = "true" ]; then
            echo "âœ… Container started successfully"
            docker logs test-container
          else
            echo "âŒ Container failed to start"
            docker logs test-container
            exit 1
          fi
      
      - name: Cleanup
        if: always()
        run: |
          docker stop test-container || true
          docker rm test-container || true
          docker rmi pr-build-verify:${{ github.event.pull_request.number }} || true

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: ${{ inputs.run_e2e_tests && github.base_ref == 'main' }}
    needs: [tests-and-quality, build-verification]
    steps:
      - name: Checkout E2E Test Suite
        uses: actions/checkout@v4
        with:
          repository: FitSync-G13/fitsync-e2e-tests
          ref: main
          path: e2e-tests
      
      - name: Setup Node.js for E2E
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: e2e-tests/package-lock.json
      
      - name: Install E2E Dependencies
        working-directory: ./e2e-tests
        run: |
          npm ci
          npx playwright install --with-deps chromium
      
      - name: Run E2E Tests
        working-directory: ./e2e-tests
        run: npx playwright test
        env:
          BASE_URL: https://dev.fitsync.online
      
      - name: Upload E2E Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ inputs.service_name }}
          path: e2e-tests/playwright-report/
          retention-days: 7
      
      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ inputs.service_name }}
          path: e2e-tests/test-results/
          retention-days: 7

  pr-status:
    name: PR Status Summary
    runs-on: ubuntu-latest
    needs: [tests-and-quality, security-scan, build-verification, e2e-tests]
    if: always()
    steps:
      - name: Check All Gates
        id: gate-check
        run: |
          # Check if all required jobs passed
          TESTS_STATUS="${{ needs.tests-and-quality.result }}"
          SECURITY_STATUS="${{ needs.security-scan.result }}"
          BUILD_STATUS="${{ needs.build-verification.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          
          echo "Tests: $TESTS_STATUS"
          echo "Security: $SECURITY_STATUS"
          echo "Build: $BUILD_STATUS"
          echo "E2E: $E2E_STATUS"
          
          # Check if any required job failed
          if [ "$TESTS_STATUS" != "success" ] || \
             ([ "$SECURITY_STATUS" != "success" ] && [ "$SECURITY_STATUS" != "skipped" ]) || \
             [ "$BUILD_STATUS" != "success" ] || \
             ([ "$E2E_STATUS" != "success" ] && [ "$E2E_STATUS" != "skipped" ]); then
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "status=passed" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR - Success
        if: steps.gate-check.outputs.status == 'passed'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âœ… All Quality Gates Passed
            
            Your PR has successfully passed all quality checks!
            
            | Check | Status |
            |-------|--------|
            | ğŸ§ª Tests & Code Quality | âœ… Passed |
            | ğŸ”’ Security Scan | âœ… Passed |
            | ğŸ—ï¸ Build Verification | âœ… Passed |
            | ğŸ­ E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || needs.e2e-tests.result == 'skipped' && 'â­ï¸ Skipped (dev branch)' || 'âŒ Failed' }} |
            
            **Service:** \`${{ inputs.service_name }}\`
            
            This PR is ready for code review and can be merged once approved.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Comment on PR - Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Quality Gates Failed
            
            Some quality checks have failed. Please review the errors and fix them.
            
            | Check | Status |
            |-------|--------|
            | ğŸ§ª Tests & Code Quality | ${{ needs.tests-and-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | ğŸ”’ Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || needs.security-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
            | ğŸ—ï¸ Build Verification | ${{ needs.build-verification.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
            | ğŸ­ E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || needs.e2e-tests.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
            
            **Service:** \`${{ inputs.service_name }}\`
            
            Please check the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error messages.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
name: Cilium CNI with Monitoring Install

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      cilium_cli_version:
        description: 'Cilium CLI version (leave empty for latest)'
        required: false
        type: string
        default: ''
      enable_hubble:
        description: 'Enable Hubble observability'
        required: false
        type: boolean
        default: true
      enable_metrics:
        description: 'Enable Prometheus metrics'
        required: false
        type: boolean
        default: true
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  install-cilium-monitoring:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-Cilium-Monitoring-Install

    - name: Uninstall existing Cilium and install via Helm
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "echo Uninstalling existing Cilium...",
            "sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml cilium uninstall || true",
            "echo Adding Cilium Helm repository...",
            "helm repo add cilium https://helm.cilium.io/",
            "helm repo update",
            "echo Installing Cilium via Helm with monitoring...",
            "helm install cilium cilium/cilium --version 1.18.4 --namespace kube-system --set prometheus.enabled=true --set operator.prometheus.enabled=true --set hubble.enabled=true --set hubble.metrics.enableOpenMetrics=true --set hubble.metrics.enabled=\"{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\\,source_namespace\\,source_workload\\,destination_ip\\,destination_namespace\\,destination_workload\\,traffic_direction}\"",
            "echo Waiting for Cilium pods to be ready...",
            "sudo k3s kubectl wait --for=condition=ready pod -l k8s-app=cilium -n kube-system --timeout=300s",
            "echo Cilium installation completed"
          ]'

    - name: Verify Cilium installation
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        sleep 60
        
        aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --parameters 'commands=[
            "sudo k3s kubectl get pods -n kube-system -l k8s-app=cilium",
            "sudo k3s kubectl get svc -n kube-system -l k8s-app=cilium"
          ]'

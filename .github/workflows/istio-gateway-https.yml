name: Istio Gateway with HTTPS

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      domain_name:
        description: 'Base domain name (leave empty to use vars.DOMAIN_NAME)'
        required: false
        type: string
        default: ''
      subdomain_prefix:
        description: 'Subdomain prefix (leave empty to use vars.SUBDOMAIN_PREFIX or for prod)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-gateway:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-IstioGateway

    - name: Deploy Istio Gateway with HTTPS
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        # Use input or fall back to vars
        DOMAIN_NAME="${{ inputs.domain_name }}"
        if [ -z "$DOMAIN_NAME" ]; then
          DOMAIN_NAME="${{ vars.DOMAIN_NAME }}"
        fi
        
        SUBDOMAIN_PREFIX="${{ inputs.subdomain_prefix }}"
        if [ -z "$SUBDOMAIN_PREFIX" ]; then
          SUBDOMAIN_PREFIX="${{ vars.SUBDOMAIN_PREFIX || '' }}"
        fi
        
        # Validate domain name
        if [ -z "$DOMAIN_NAME" ]; then
          echo "Error: domain_name is required but was empty"
          exit 1
        fi
        
        if [ -z "$SUBDOMAIN_PREFIX" ]; then
          CERT_NAME="prod-wildcard-cert"
          GATEWAY_NAME="prod-gateway"
          HOST_PATTERN="*.$DOMAIN_NAME"
          ROOT_HOST="$DOMAIN_NAME"
        else
          CERT_NAME="$SUBDOMAIN_PREFIX-wildcard-cert"
          GATEWAY_NAME="$SUBDOMAIN_PREFIX-gateway"
          HOST_PATTERN="*.$SUBDOMAIN_PREFIX.$DOMAIN_NAME"
          ROOT_HOST="$SUBDOMAIN_PREFIX.$DOMAIN_NAME"
        fi
        
        echo "Deploying Gateway: $GATEWAY_NAME"
        echo "Hosts: $HOST_PATTERN, $ROOT_HOST"
        echo "Certificate: $CERT_NAME"
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo 'apiVersion: networking.istio.io/v1beta1' > /tmp/gateway.yaml\",
            \"echo 'kind: Gateway' >> /tmp/gateway.yaml\",
            \"echo 'metadata:' >> /tmp/gateway.yaml\",
            \"echo '  name: ${GATEWAY_NAME}' >> /tmp/gateway.yaml\",
            \"echo '  namespace: istio-system' >> /tmp/gateway.yaml\",
            \"echo 'spec:' >> /tmp/gateway.yaml\",
            \"echo '  selector:' >> /tmp/gateway.yaml\",
            \"echo '    istio: ingressgateway' >> /tmp/gateway.yaml\",
            \"echo '  servers:' >> /tmp/gateway.yaml\",
            \"echo '  - port:' >> /tmp/gateway.yaml\",
            \"echo '      number: 80' >> /tmp/gateway.yaml\",
            \"echo '      name: http' >> /tmp/gateway.yaml\",
            \"echo '      protocol: HTTP' >> /tmp/gateway.yaml\",
            \"echo '    hosts:' >> /tmp/gateway.yaml\",
            \"echo '    - \\\"${HOST_PATTERN}\\\"' >> /tmp/gateway.yaml\",
            \"echo '    - \\\"${ROOT_HOST}\\\"' >> /tmp/gateway.yaml\",
            \"echo '    tls:' >> /tmp/gateway.yaml\",
            \"echo '      httpsRedirect: true' >> /tmp/gateway.yaml\",
            \"echo '  - port:' >> /tmp/gateway.yaml\",
            \"echo '      number: 443' >> /tmp/gateway.yaml\",
            \"echo '      name: https' >> /tmp/gateway.yaml\",
            \"echo '      protocol: HTTPS' >> /tmp/gateway.yaml\",
            \"echo '    hosts:' >> /tmp/gateway.yaml\",
            \"echo '    - \\\"${HOST_PATTERN}\\\"' >> /tmp/gateway.yaml\",
            \"echo '    - \\\"${ROOT_HOST}\\\"' >> /tmp/gateway.yaml\",
            \"echo '    tls:' >> /tmp/gateway.yaml\",
            \"echo '      mode: SIMPLE' >> /tmp/gateway.yaml\",
            \"echo '      credentialName: ${CERT_NAME}' >> /tmp/gateway.yaml\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl apply -f /tmp/gateway.yaml\",
            \"rm /tmp/gateway.yaml\",
            \"echo Gateway deployed\",
            \"sudo KUBECONFIG=/etc/rancher/k3s/k3s.yaml kubectl get gateway.networking.istio.io ${GATEWAY_NAME} -n istio-system\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for deployment to complete..."
        
        MAX_ATTEMPTS=30
        ATTEMPT=0
        STATUS="InProgress"
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ] && [ "$STATUS" = "InProgress" ]; do
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$FIRST_MASTER" \
            --query 'Status' \
            --output text 2>/dev/null || echo "InProgress")
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - Status: $STATUS"
        done
        
        echo "Getting command output..."
        STDOUT_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text)
        
        echo "Output:"
        echo "$STDOUT_OUTPUT"
        
        if [ "$STATUS" = "Success" ]; then
          echo "Gateway deployment completed successfully"
        else
          echo "Gateway deployment failed with status: $STATUS"
          exit 1
        fi

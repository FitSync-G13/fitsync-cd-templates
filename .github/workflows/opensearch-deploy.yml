name: OpenSearch Deployment

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      opensearch_version:
        description: 'OpenSearch version'
        required: false
        type: string
        default: '2.19.4'
      cert_manager_version:
        description: 'cert-manager version (leave empty for latest)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true
      CLOUDFLARE_API_TOKEN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  install-ebs-csi-driver:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-EBS-CSI

    - name: Install AWS EBS CSI Driver
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Installing AWS EBS CSI Driver on OpenSearch cluster..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo \"Installing AWS EBS CSI Driver...\"",
            "sudo k3s kubectl apply -k \"github.com/kubernetes-sigs/aws-ebs-csi-driver/deploy/kubernetes/overlays/stable/?ref=release-1.25\"",
            "echo \"Waiting for EBS CSI Driver to be ready...\"",
            "sudo k3s kubectl wait --for=condition=ready pod -l app=ebs-csi-controller -n kube-system --timeout=300s",
            "sudo k3s kubectl wait --for=condition=ready pod -l app=ebs-csi-node -n kube-system --timeout=300s",
            "echo \"EBS CSI Driver installed successfully\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

  create-opensearch-storage:
    needs: install-ebs-csi-driver
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-Storage

    - name: Create OpenSearch PersistentVolume
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating OpenSearch PersistentVolume with EBS volume: ${{ vars.OPENSEARCH_EBS_VOLUME_ID }}"
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo 'Creating OpenSearch PersistentVolume...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: v1\",
            \"kind: PersistentVolume\",
            \"metadata:\",
            \"  name: opensearch-storage\",
            \"  labels:\",
            \"    app: opensearch\",
            \"spec:\",
            \"  capacity:\",
            \"    storage: ${{ vars.OPENSEARCH_VOL_SIZE || '50' }}Gi\",
            \"  accessModes:\",
            \"    - ReadWriteOnce\",
            \"  persistentVolumeReclaimPolicy: Retain\",
            \"  storageClassName: ebs-sc\",
            \"  csi:\",
            \"    driver: ebs.csi.aws.com\",
            \"    volumeHandle: ${{ vars.OPENSEARCH_EBS_VOLUME_ID }}\",
            \"    fsType: ext4\",
            \"---\",
            \"apiVersion: storage.k8s.io/v1\",
            \"kind: StorageClass\",
            \"metadata:\",
            \"  name: ebs-sc\",
            \"provisioner: ebs.csi.aws.com\",
            \"volumeBindingMode: WaitForFirstConsumer\",
            \"EOF\",
            \"echo 'PersistentVolume created successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

  install-cert-manager:
    needs: create-opensearch-storage
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Determine cert-manager version
      id: version
      run: |
        if [ -z "${{ inputs.cert_manager_version }}" ]; then
          echo "Fetching latest cert-manager version..."
          LATEST_VERSION=$(curl -s https://api.github.com/repos/cert-manager/cert-manager/releases/latest | jq -r '.tag_name')
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "Using latest version: $LATEST_VERSION"
        else
          echo "version=v${{ inputs.cert_manager_version }}" >> $GITHUB_OUTPUT
          echo "Using specified version: v${{ inputs.cert_manager_version }}"
        fi

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-CertManager

    - name: Install cert-manager
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        CERT_MANAGER_VERSION="${{ steps.version.outputs.version }}"
        
        echo "Installing cert-manager $CERT_MANAGER_VERSION on OpenSearch cluster..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters "commands=[
            \"echo 'Installing cert-manager $CERT_MANAGER_VERSION...'\",
            \"sudo k3s kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/$CERT_MANAGER_VERSION/cert-manager.yaml\",
            \"echo 'Waiting for cert-manager to be ready...'\",
            \"sudo k3s kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=cert-manager -n cert-manager --timeout=300s\",
            \"sudo k3s kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=cainjector -n cert-manager --timeout=300s\",
            \"sudo k3s kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=webhook -n cert-manager --timeout=300s\",
            \"echo 'cert-manager installed successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

  create-wildcard-cert:
    needs: install-cert-manager
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-WildcardCert

    - name: Create Cloudflare API token secret and ClusterIssuer
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating Cloudflare API token secret and ClusterIssuer..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo 'Creating Cloudflare API token secret...'\",
            \"sudo k3s kubectl create secret generic cloudflare-api-token-secret --from-literal=api-token='${{ secrets.CLOUDFLARE_API_TOKEN }}' -n cert-manager --dry-run=client -o yaml | sudo k3s kubectl apply -f -\",
            \"echo 'Creating ClusterIssuer...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: cert-manager.io/v1\",
            \"kind: ClusterIssuer\",
            \"metadata:\",
            \"  name: letsencrypt-prod\",
            \"spec:\",
            \"  acme:\",
            \"    server: https://acme-v02.api.letsencrypt.org/directory\",
            \"    email: ${{ vars.CERT_EMAIL || 'admin@fitsync.online' }}\",
            \"    privateKeySecretRef:\",
            \"      name: letsencrypt-prod\",
            \"    solvers:\",
            \"    - dns01:\",
            \"        cloudflare:\",
            \"          apiTokenSecretRef:\",
            \"            name: cloudflare-api-token-secret\",
            \"            key: api-token\",
            \"EOF\",
            \"echo 'ClusterIssuer created successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Create wildcard certificate
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating wildcard certificate for OpenSearch..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters "commands=[
            \"echo 'Creating wildcard certificate for internal OpenSearch...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: cert-manager.io/v1\",
            \"kind: Certificate\",
            \"metadata:\",
            \"  name: opensearch-wildcard-cert\",
            \"  namespace: default\",
            \"spec:\",
            \"  secretName: opensearch-wildcard-tls\",
            \"  issuerRef:\",
            \"    name: letsencrypt-prod\",
            \"    kind: ClusterIssuer\",
            \"  dnsNames:\",
            \"  - '${{ vars.OPENSEARCH_SUBDOMAIN }}'\",
            \"  - '*.opensearch.local'\",
            \"---\",
            \"apiVersion: cert-manager.io/v1\",
            \"kind: Certificate\",
            \"metadata:\",
            \"  name: opensearch-dashboard-public-cert\",
            \"  namespace: default\",
            \"spec:\",
            \"  secretName: opensearch-dashboard-public-tls\",
            \"  issuerRef:\",
            \"    name: letsencrypt-prod\",
            \"    kind: ClusterIssuer\",
            \"  dnsNames:\",
            \"  - '${{ vars.OPENSEARCH_DASHBOARD_FQDN }}'\",
            \"EOF\",
            \"echo 'Waiting for certificates to be ready...'\",
            \"sudo k3s kubectl wait --for=condition=ready certificate opensearch-wildcard-cert --timeout=300s\",
            \"sudo k3s kubectl wait --for=condition=ready certificate opensearch-dashboard-public-cert --timeout=300s\",
            \"echo 'Certificates created successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

  deploy-opensearch:
    needs: create-wildcard-cert
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-Deploy

    - name: Install OpenSearch Operator
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Installing OpenSearch Operator..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo \"Installing OpenSearch Operator...\"",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchclusters.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchroles.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchusers.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchuserrolesbindings.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchactiongroups.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchtenants.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchismtemplates.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchismpolicies.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchcomponenttemplates.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/config/crd/bases/opensearch.opster.io_opensearchindextemplates.yaml",
            "sudo k3s kubectl apply -f https://raw.githubusercontent.com/opensearch-project/opensearch-k8s-operator/main/opensearch-operator/opensearch-operator.yaml",
            "echo \"Waiting for OpenSearch Operator to be ready...\"",
            "sudo k3s kubectl wait --for=condition=ready pod -l control-plane=opensearch-operator-controller-manager -n opensearch-operator-system --timeout=300s",
            "echo \"OpenSearch Operator installed successfully\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Deploy OpenSearch Cluster
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Deploying OpenSearch Cluster..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 900 \
          --parameters "commands=[
            \"echo 'Creating OpenSearch Cluster...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: opensearch.opster.io/v1\",
            \"kind: OpenSearchCluster\",
            \"metadata:\",
            \"  name: opensearch-cluster\",
            \"  namespace: default\",
            \"spec:\",
            \"  general:\",
            \"    httpPort: 9200\",
            \"    vendor: opensearch\",
            \"    version: '${{ inputs.opensearch_version }}'\",
            \"    serviceName: opensearch-cluster\",
            \"  dashboards:\",
            \"    enable: true\",
            \"    version: '${{ inputs.opensearch_version }}'\",
            \"    replicas: 1\",
            \"    resources:\",
            \"      requests:\",
            \"        memory: '512Mi'\",
            \"        cpu: '200m'\",
            \"      limits:\",
            \"        memory: '1Gi'\",
            \"        cpu: '500m'\",
            \"  nodePools:\",
            \"  - component: masters\",
            \"    replicas: ${{ vars.OPENSEARCH_MASTER_COUNT || '1' }}\",
            \"    diskSize: '20Gi'\",
            \"    resources:\",
            \"      requests:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"      limits:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"    roles:\",
            \"    - 'cluster_manager'\",
            \"    - 'data'\",
            \"    persistence:\",
            \"      persistentVolumeClaim:\",
            \"        storageClass: ebs-sc\",
            \"        accessModes:\",
            \"        - ReadWriteOnce\",
            \"  - component: data\",
            \"    replicas: ${{ vars.OPENSEARCH_WORKER_COUNT || '1' }}\",
            \"    diskSize: '50Gi'\",
            \"    resources:\",
            \"      requests:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"      limits:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"    roles:\",
            \"    - 'data'\",
            \"    - 'ingest'\",
            \"    persistence:\",
            \"      persistentVolumeClaim:\",
            \"        storageClass: ebs-sc\",
            \"        accessModes:\",
            \"        - ReadWriteOnce\",
            \"EOF\",
            \"echo 'Waiting for OpenSearch Cluster to be ready...'\",
            \"sudo k3s kubectl wait --for=condition=ready pod -l opster.io/opensearch-cluster=opensearch-cluster --timeout=600s\",
            \"echo 'OpenSearch Cluster deployed successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

  expose-opensearch:
    needs: deploy-opensearch
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-Expose

    - name: Create Traefik IngressRoute for OpenSearch
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating Traefik IngressRoute for OpenSearch..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters "commands=[
            \"echo 'Creating Traefik IngressRoute for OpenSearch...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: traefik.containo.us/v1alpha1\",
            \"kind: IngressRoute\",
            \"metadata:\",
            \"  name: opensearch-ingress\",
            \"  namespace: default\",
            \"spec:\",
            \"  entryPoints:\",
            \"  - websecure\",
            \"  routes:\",
            \"  - match: Host(\\\`${{ vars.OPENSEARCH_SUBDOMAIN }}\\\`)\",
            \"    kind: Rule\",
            \"    services:\",
            \"    - name: opensearch-cluster\",
            \"      port: 9200\",
            \"  tls:\",
            \"    secretName: opensearch-wildcard-tls\",
            \"---\",
            \"apiVersion: traefik.containo.us/v1alpha1\",
            \"kind: IngressRoute\",
            \"metadata:\",
            \"  name: opensearch-dashboards-ingress\",
            \"  namespace: default\",
            \"spec:\",
            \"  entryPoints:\",
            \"  - websecure\",
            \"  routes:\",
            \"  - match: Host(\\\`dashboards.${{ vars.OPENSEARCH_SUBDOMAIN }}\\\`) || Host(\\\`kibana.${{ vars.OPENSEARCH_SUBDOMAIN }}\\\`)\",
            \"    kind: Rule\",
            \"    services:\",
            \"    - name: opensearch-cluster-dashboards\",
            \"      port: 5601\",
            \"  tls:\",
            \"    secretName: opensearch-wildcard-tls\",
            \"---\",
            \"apiVersion: v1\",
            \"kind: Service\",
            \"metadata:\",
            \"  name: opensearch-dashboard-public\",
            \"  namespace: default\",
            \"spec:\",
            \"  type: NodePort\",
            \"  ports:\",
            \"  - name: https\",
            \"    port: 5601\",
            \"    targetPort: 5601\",
            \"    nodePort: 30601\",
            \"    protocol: TCP\",
            \"  selector:\",
            \"    opster.io/opensearch-cluster: opensearch-cluster\",
            \"    opensearch.role: dashboards\",
            \"---\",
            \"apiVersion: v1\",
            \"kind: Service\",
            \"metadata:\",
            \"  name: opensearch-service-public\",
            \"  namespace: default\",
            \"spec:\",
            \"  type: NodePort\",
            \"  ports:\",
            \"  - name: https\",
            \"    port: 9200\",
            \"    targetPort: 9200\",
            \"    nodePort: 30920\",
            \"    protocol: TCP\",
            \"  selector:\",
            \"    opster.io/opensearch-cluster: opensearch-cluster\",
            \"    opensearch.role: masters\",
            \"---\",
            \"apiVersion: traefik.containo.us/v1alpha1\",
            \"kind: IngressRoute\",
            \"metadata:\",
            \"  name: opensearch-service-private-ingress\",
            \"  namespace: default\",
            \"spec:\",
            \"  entryPoints:\",
            \"  - websecure\",
            \"  routes:\",
            \"  - match: Host(\\\`${{ vars.OPENSEARCH_SUBDOMAIN }}\\\`)\",
            \"    kind: Rule\",
            \"    services:\",
            \"    - name: opensearch-service-public\",
            \"      port: 9200\",
            \"  tls:\",
            \"    secretName: opensearch-wildcard-tls\",
            \"---\",
            \"apiVersion: traefik.containo.us/v1alpha1\",
            \"kind: IngressRoute\",
            \"metadata:\",
            \"  name: opensearch-dashboard-public-ingress\",
            \"  namespace: default\",
            \"spec:\",
            \"  entryPoints:\",
            \"  - websecure\",
            \"  routes:\",
            \"  - match: Host(\\\`${{ vars.OPENSEARCH_DASHBOARD_FQDN }}\\\`)\",
            \"    kind: Rule\",
            \"    services:\",
            \"    - name: opensearch-dashboard-public\",
            \"      port: 5601\",
            \"  tls:\",
            \"    secretName: opensearch-dashboard-public-tls\",
            \"EOF\",
            \"echo 'IngressRoute created successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Verify OpenSearch deployment
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying OpenSearch deployment..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo \"OpenSearch Cluster Status:\"",
            "sudo k3s kubectl get opensearchcluster -o wide",
            "echo \"OpenSearch Pods:\"",
            "sudo k3s kubectl get pods -l opster.io/opensearch-cluster=opensearch-cluster",
            "echo \"OpenSearch Services:\"",
            "sudo k3s kubectl get svc -l opster.io/opensearch-cluster=opensearch-cluster",
            "echo \"IngressRoutes:\"",
            "sudo k3s kubectl get ingressroute",
            "echo \"Certificates:\"",
            "sudo k3s kubectl get certificate"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

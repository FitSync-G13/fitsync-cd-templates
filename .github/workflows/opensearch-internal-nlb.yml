name: OpenSearch Internal NLB Setup

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  create-internal-nlb-service:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-InternalNLB

    - name: Create Internal NLB Service for OpenSearch API
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating Internal NLB Service for OpenSearch API..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo Creating Internal NLB Service for OpenSearch API...",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: v1",
            "kind: Service",
            "metadata:",
            "  name: opensearch-api-internal-nlb",
            "  namespace: opensearch",
            "  annotations:",
            "    service.beta.kubernetes.io/aws-load-balancer-type: nlb",
            "    service.beta.kubernetes.io/aws-load-balancer-scheme: internal",
            "    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: \"true\"",
            "spec:",
            "  type: LoadBalancer",
            "  ports:",
            "  - name: opensearch-api",
            "    port: 9200",
            "    targetPort: 9200",
            "    protocol: TCP",
            "  selector:",
            "    app.kubernetes.io/name: opensearch",
            "    app.kubernetes.io/component: opensearch-cluster-master",
            "EOF",
            "echo Internal NLB Service created successfully",
            "echo Waiting for LoadBalancer to be provisioned...",
            "sleep 60",
            "echo LoadBalancer status:",
            "sudo k3s kubectl get svc opensearch-api-internal-nlb -n opensearch"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Verify Internal NLB Setup
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying Internal NLB setup..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo === Internal NLB Service Status ===",
            "sudo k3s kubectl get svc opensearch-api-internal-nlb -n opensearch -o wide",
            "echo === OpenSearch Pods ===",
            "sudo k3s kubectl get pods -n opensearch -l app.kubernetes.io/name=opensearch",
            "echo === OpenSearch Service Endpoints ===",
            "sudo k3s kubectl get endpoints -n opensearch",
            "echo === Test OpenSearch API via Internal Service ===",
            "INTERNAL_IP=$(sudo k3s kubectl get svc opensearch-api-internal-nlb -n opensearch -o jsonpath=\"{.status.loadBalancer.ingress[0].ip}\")",
            "if [ ! -z \"$INTERNAL_IP\" ]; then",
            "  echo \"Internal NLB IP: $INTERNAL_IP\"",
            "  echo \"Testing OpenSearch API via Internal NLB...\"",
            "  curl -k -m 10 https://$INTERNAL_IP:9200/_cluster/health || echo \"Connection test completed\"",
            "else",
            "  echo \"Internal NLB IP not yet available\"",
            "fi"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

name: OpenSearch Cluster Deploy

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-opensearch-cluster:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-Cluster

    - name: Deploy OpenSearch Cluster
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Deploying OpenSearch Cluster..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 900 \
          --parameters "commands=[
            \"echo 'Creating OpenSearch Cluster...'\",
            \"cat <<EOF | sudo k3s kubectl apply -f -\",
            \"apiVersion: opensearch.opster.io/v1\",
            \"kind: OpenSearchCluster\",
            \"metadata:\",
            \"  name: opensearch-cluster\",
            \"  namespace: default\",
            \"spec:\",
            \"  general:\",
            \"    httpPort: 9200\",
            \"    vendor: opensearch\",
            \"    version: '2.19.4'\",
            \"    serviceName: opensearch-cluster\",
            \"  dashboards:\",
            \"    enable: true\",
            \"    version: '2.19.4'\",
            \"    replicas: 1\",
            \"    resources:\",
            \"      requests:\",
            \"        memory: '512Mi'\",
            \"        cpu: '200m'\",
            \"      limits:\",
            \"        memory: '1Gi'\",
            \"        cpu: '500m'\",
            \"  nodePools:\",
            \"  - component: masters\",
            \"    replicas: ${{ vars.OPENSEARCH_MASTER_COUNT || '1' }}\",
            \"    diskSize: '20Gi'\",
            \"    resources:\",
            \"      requests:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"      limits:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"    roles:\",
            \"    - 'cluster_manager'\",
            \"    - 'data'\",
            \"    persistence:\",
            \"      persistentVolumeClaim:\",
            \"        storageClass: ebs-sc\",
            \"        accessModes:\",
            \"        - ReadWriteOnce\",
            \"  - component: data\",
            \"    replicas: ${{ vars.OPENSEARCH_WORKER_COUNT || '1' }}\",
            \"    diskSize: '50Gi'\",
            \"    resources:\",
            \"      requests:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"      limits:\",
            \"        memory: '2Gi'\",
            \"        cpu: '500m'\",
            \"    roles:\",
            \"    - 'data'\",
            \"    - 'ingest'\",
            \"    persistence:\",
            \"      persistentVolumeClaim:\",
            \"        storageClass: ebs-sc\",
            \"        accessModes:\",
            \"        - ReadWriteOnce\",
            \"EOF\",
            \"echo 'Waiting for OpenSearch Cluster to be ready...'\",
            \"sudo k3s kubectl wait --for=condition=ready pod -l opster.io/opensearch-cluster=opensearch-cluster --timeout=600s\",
            \"echo 'OpenSearch Cluster deployed successfully'\"
          ]" \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

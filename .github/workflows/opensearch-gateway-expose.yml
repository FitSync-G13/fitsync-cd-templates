name: OpenSearch Gateway API Expose

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  setup-gateway-api:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-GatewayAPI

    - name: Setup Gateway API Prerequisites
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Setting up Gateway API prerequisites on $FIRST_MASTER..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "set -e",
            "echo \"=== Installing Gateway API CRDs ===\"",
            "sudo k3s kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml || echo \"CRDs already exist\"",
            "sleep 10",
            "echo \"=== Creating RBAC permissions for Traefik Gateway API ===\"",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: rbac.authorization.k8s.io/v1",
            "kind: ClusterRole",
            "metadata:",
            "  name: traefik-gateway-api",
            "rules:",
            "- apiGroups: [\"gateway.networking.k8s.io\"]",
            "  resources: [\"gatewayclasses\", \"gateways\", \"httproutes\", \"grpcroutes\", \"referencegrants\"]",
            "  verbs: [\"get\", \"list\", \"watch\", \"update\", \"patch\"]",
            "- apiGroups: [\"gateway.networking.k8s.io\"]",
            "  resources: [\"gatewayclasses/status\", \"gateways/status\", \"httproutes/status\", \"grpcroutes/status\"]",
            "  verbs: [\"update\", \"patch\"]",
            "- apiGroups: [\"\"]",
            "  resources: [\"namespaces\"]",
            "  verbs: [\"get\", \"list\", \"watch\"]",
            "---",
            "apiVersion: rbac.authorization.k8s.io/v1",
            "kind: ClusterRoleBinding",
            "metadata:",
            "  name: traefik-gateway-api",
            "roleRef:",
            "  apiGroup: rbac.authorization.k8s.io",
            "  kind: ClusterRole",
            "  name: traefik-gateway-api",
            "subjects:",
            "- kind: ServiceAccount",
            "  name: traefik",
            "  namespace: kube-system",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: GatewayClass",
            "metadata:",
            "  name: traefik",
            "spec:",
            "  controllerName: traefik.io/gateway-controller",
            "EOF",
            "echo \"=== Creating cross-namespace ReferenceGrant ===\"",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: gateway.networking.k8s.io/v1beta1",
            "kind: ReferenceGrant",
            "metadata:",
            "  name: opensearch-cross-namespace",
            "  namespace: opensearch",
            "spec:",
            "  from:",
            "  - group: gateway.networking.k8s.io",
            "    kind: HTTPRoute",
            "    namespace: default",
            "  to:",
            "  - group: \"\"",
            "    kind: Service",
            "EOF",
            "echo \"=== Enabling Gateway API support in Traefik ===\"",
            "sudo k3s kubectl get deployment traefik -n kube-system -o yaml | grep -q \"providers.kubernetesgateway\" || sudo k3s kubectl patch deployment traefik -n kube-system --type=json -p=\"[{\\\"op\\\": \\\"add\\\", \\\"path\\\": \\\"/spec/template/spec/containers/0/args/-\\\", \\\"value\\\": \\\"--providers.kubernetesgateway\\\"}]\"",
            "echo \"=== Restarting Traefik ===\"",
            "sudo k3s kubectl rollout restart deployment/traefik -n kube-system",
            "sudo k3s kubectl rollout status deployment/traefik -n kube-system --timeout=300s",
            "echo \"=== Gateway API prerequisites setup completed ===\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for command to complete..."
        
        if aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$FIRST_MASTER"; then
          echo "âœ… Command completed successfully"
        else
          echo "âŒ Command failed or timed out"
        fi
        
        # Always get output and errors
        echo "=== Command Output ==="
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "No output available"
        
        echo "=== Command Errors ==="
        ERROR_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardErrorContent' \
          --output text || echo "No errors available")
        
        if [ "$ERROR_OUTPUT" != "No errors available" ] && [ -n "$ERROR_OUTPUT" ]; then
          echo "$ERROR_OUTPUT"
        fi
        
        # Check final status
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        echo "Final command status: $STATUS"
        
        if [ "$STATUS" != "Success" ]; then
          echo "âŒ Prerequisites setup failed"
          exit 1
        fi

    - name: Create Gateway and HTTPRoutes
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating Gateway and HTTPRoutes on $FIRST_MASTER..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "set -e",
            "echo \"=== Creating wildcard Gateway ===\"",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: Gateway",
            "metadata:",
            "  name: opensearch-gateway",
            "  namespace: default",
            "spec:",
            "  gatewayClassName: traefik",
            "  listeners:",
            "  - name: opensearch-https",
            "    port: 8443",
            "    protocol: HTTPS",
            "    tls:",
            "      mode: Terminate",
            "      certificateRefs:",
            "      - name: opensearch-wildcard-tls",
            "        namespace: default",
            "EOF",
            "echo \"=== Creating HTTPRoutes ===\"",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: HTTPRoute",
            "metadata:",
            "  name: opensearch-dashboard-route",
            "  namespace: default",
            "spec:",
            "  parentRefs:",
            "  - name: opensearch-gateway",
            "  hostnames:",
            "  - ${{ vars.OPENSEARCH_DASHBOARD_FQDN }}",
            "  rules:",
            "  - matches:",
            "    - path:",
            "        type: PathPrefix",
            "        value: \"/\"",
            "    backendRefs:",
            "    - name: opensearch-dashboards",
            "      namespace: opensearch",
            "      port: 5601",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: HTTPRoute",
            "metadata:",
            "  name: opensearch-api-route",
            "  namespace: default",
            "spec:",
            "  parentRefs:",
            "  - name: opensearch-gateway",
            "  hostnames:",
            "  - ${{ vars.OPENSEARCH_SUBDOMAIN }}",
            "  rules:",
            "  - matches:",
            "    - path:",
            "        type: PathPrefix",
            "        value: \"/\"",
            "    backendRefs:",
            "    - name: opensearch-cluster-master",
            "      namespace: opensearch",
            "      port: 9200",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: HTTPRoute",
            "metadata:",
            "  name: default-dashboard-route",
            "  namespace: default",
            "spec:",
            "  parentRefs:",
            "  - name: opensearch-gateway",
            "  rules:",
            "  - matches:",
            "    - path:",
            "        type: PathPrefix",
            "        value: \"/\"",
            "    backendRefs:",
            "    - name: opensearch-dashboards",
            "      namespace: opensearch",
            "      port: 5601",
            "EOF",
            "echo \"=== Gateway and HTTPRoutes created successfully ===\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for command to complete..."
        
        if aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$FIRST_MASTER"; then
          echo "âœ… Command completed successfully"
        else
          echo "âŒ Command failed or timed out"
        fi
        
        # Always get output and errors
        echo "=== Command Output ==="
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "No output available"
        
        echo "=== Command Errors ==="
        ERROR_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardErrorContent' \
          --output text || echo "No errors available")
        
        if [ "$ERROR_OUTPUT" != "No errors available" ] && [ -n "$ERROR_OUTPUT" ]; then
          echo "$ERROR_OUTPUT"
        fi
        
        # Check final status
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        echo "Final command status: $STATUS"
        
        if [ "$STATUS" != "Success" ]; then
          echo "âŒ Gateway creation failed"
          exit 1
        fi

    - name: Create NodePort Services
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating NodePort services on $FIRST_MASTER..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "set -e",
            "echo \"=== Creating NodePort services in kube-system namespace ===\"",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: v1",
            "kind: Service",
            "metadata:",
            "  name: opensearch-dashboard-nodeport",
            "  namespace: kube-system",
            "spec:",
            "  type: NodePort",
            "  ports:",
            "  - name: https",
            "    port: 443",
            "    targetPort: 8443",
            "    nodePort: 30601",
            "    protocol: TCP",
            "  selector:",
            "    app.kubernetes.io/instance: traefik-kube-system",
            "    app.kubernetes.io/name: traefik",
            "---",
            "apiVersion: v1",
            "kind: Service",
            "metadata:",
            "  name: opensearch-api-nodeport",
            "  namespace: kube-system",
            "spec:",
            "  type: NodePort",
            "  ports:",
            "  - name: https",
            "    port: 443",
            "    targetPort: 8443",
            "    nodePort: 30920",
            "    protocol: TCP",
            "  selector:",
            "    app.kubernetes.io/instance: traefik-kube-system",
            "    app.kubernetes.io/name: traefik",
            "EOF",
            "echo \"=== NodePort services created successfully ===\"",
            "echo \"=== Verifying setup ===\"",
            "sudo k3s kubectl get gateway -A",
            "sudo k3s kubectl get httproute -A", 
            "sudo k3s kubectl get service -n kube-system | grep opensearch",
            "echo \"=== Gateway API setup completed ===\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        echo "Command ID: $COMMAND_ID"
        echo "Waiting for command to complete..."
        
        if aws ssm wait command-executed --command-id "$COMMAND_ID" --instance-id "$FIRST_MASTER"; then
          echo "âœ… Command completed successfully"
        else
          echo "âŒ Command failed or timed out"
        fi
        
        # Always get output and errors
        echo "=== Command Output ==="
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text || echo "No output available"
        
        echo "=== Command Errors ==="
        ERROR_OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardErrorContent' \
          --output text || echo "No errors available")
        
        if [ "$ERROR_OUTPUT" != "No errors available" ] && [ -n "$ERROR_OUTPUT" ]; then
          echo "$ERROR_OUTPUT"
        fi
        
        # Check final status
        STATUS=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'Status' \
          --output text)
        
        echo "Final command status: $STATUS"
        
        if [ "$STATUS" != "Success" ]; then
          echo "âŒ NodePort services creation failed"
          exit 1
        fi
        
        echo "ðŸŽ‰ OpenSearch Gateway API exposure completed successfully!"
        echo ""
        echo "ðŸ“‹ Summary:"
        echo "  âœ… Gateway API CRDs installed"
        echo "  âœ… RBAC permissions configured"
        echo "  âœ… Gateway created with wildcard TLS"
        echo "  âœ… HTTPRoutes configured for Dashboard and API"
        echo "  âœ… NodePort services created"
        echo ""
        echo "ðŸ”— Access URLs:"
        echo "  Dashboard: https://${{ vars.OPENSEARCH_DASHBOARD_FQDN }}"
        echo "  API: https://${{ vars.OPENSEARCH_SUBDOMAIN }}"

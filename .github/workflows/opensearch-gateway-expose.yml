name: OpenSearch Gateway API Expose

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  setup-gateway-api:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-GatewayAPI

    - name: Verify certificates are ready
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying certificates are ready..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo Checking certificate status...",
            "sudo k3s kubectl get certificate -A",
            "echo Waiting for certificates to be ready...",
            "sudo k3s kubectl wait --for=condition=Ready certificate/opensearch-wildcard-cert -n default --timeout=300s",
            "sudo k3s kubectl wait --for=condition=Ready certificate/opensearch-dashboard-public-cert -n default --timeout=300s",
            "echo All certificates are ready"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"

    - name: Setup Gateway API Prerequisites
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Setting up Gateway API prerequisites..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo Installing Gateway API CRDs...",
            "sudo k3s kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml",
            "sleep 30",
            "echo Creating RBAC permissions for Traefik Gateway API...",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: rbac.authorization.k8s.io/v1",
            "kind: ClusterRole",
            "metadata:",
            "  name: traefik-gateway-api",
            "rules:",
            "- apiGroups: [\"gateway.networking.k8s.io\"]",
            "  resources: [\"gatewayclasses\", \"gateways\", \"httproutes\", \"grpcroutes\", \"referencegrants\"]",
            "  verbs: [\"get\", \"list\", \"watch\", \"update\", \"patch\"]",
            "- apiGroups: [\"gateway.networking.k8s.io\"]",
            "  resources: [\"gatewayclasses/status\", \"gateways/status\", \"httproutes/status\", \"grpcroutes/status\"]",
            "  verbs: [\"update\", \"patch\"]",
            "- apiGroups: [\"\"]",
            "  resources: [\"namespaces\"]",
            "  verbs: [\"get\", \"list\", \"watch\"]",
            "---",
            "apiVersion: rbac.authorization.k8s.io/v1",
            "kind: ClusterRoleBinding",
            "metadata:",
            "  name: traefik-gateway-api",
            "roleRef:",
            "  apiGroup: rbac.authorization.k8s.io",
            "  kind: ClusterRole",
            "  name: traefik-gateway-api",
            "subjects:",
            "- kind: ServiceAccount",
            "  name: traefik",
            "  namespace: kube-system",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: GatewayClass",
            "metadata:",
            "  name: traefik",
            "spec:",
            "  controllerName: traefik.io/gateway-controller",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1beta1",
            "kind: ReferenceGrant",
            "metadata:",
            "  name: opensearch-cross-namespace",
            "  namespace: opensearch",
            "spec:",
            "  from:",
            "  - group: gateway.networking.k8s.io",
            "    kind: HTTPRoute",
            "    namespace: default",
            "  to:",
            "  - group: \"\"",
            "    kind: Service",
            "EOF",
            "echo Enabling Gateway API support in Traefik...",
            "sudo k3s kubectl patch deployment traefik -n kube-system --type=json -p=\"[{\\\"op\\\": \\\"add\\\", \\\"path\\\": \\\"/spec/template/spec/containers/0/args/-\\\", \\\"value\\\": \\\"--providers.kubernetesgateway\\\"}]\"",
            "echo Restarting Traefik to pick up new permissions...",
            "sudo k3s kubectl rollout restart deployment/traefik -n kube-system",
            "sudo k3s kubectl rollout status deployment/traefik -n kube-system --timeout=300s"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"

    - name: Create Gateway and HTTPRoutes
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating Gateway and HTTPRoutes..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo Creating wildcard Gateway...",
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: Gateway",
            "metadata:",
            "  name: opensearch-gateway",
            "  namespace: default",
            "spec:",
            "  gatewayClassName: traefik",
            "  listeners:",
            "  - name: opensearch-https",
            "    port: 8443",
            "    protocol: HTTPS",
            "    tls:",
            "      mode: Terminate",
            "      certificateRefs:",
            "      - name: opensearch-wildcard-tls",
            "        namespace: default",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: HTTPRoute",
            "metadata:",
            "  name: opensearch-dashboard-route",
            "  namespace: default",
            "spec:",
            "  parentRefs:",
            "  - name: opensearch-gateway",
            "  hostnames:",
            "  - ${{ vars.OPENSEARCH_DASHBOARD_FQDN }}",
            "  rules:",
            "  - matches:",
            "    - path:",
            "        type: PathPrefix",
            "        value: \\\"/\\\"",
            "    backendRefs:",
            "    - name: opensearch-dashboards",
            "      namespace: opensearch",
            "      port: 5601",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: HTTPRoute",
            "metadata:",
            "  name: opensearch-api-route",
            "  namespace: default",
            "spec:",
            "  parentRefs:",
            "  - name: opensearch-gateway",
            "  hostnames:",
            "  - ${{ vars.OPENSEARCH_SUBDOMAIN }}",
            "  rules:",
            "  - matches:",
            "    - path:",
            "        type: PathPrefix",
            "        value: \\\"/\\\"",
            "    backendRefs:",
            "    - name: opensearch-cluster-master",
            "      namespace: opensearch",
            "      port: 9200",
            "---",
            "apiVersion: gateway.networking.k8s.io/v1",
            "kind: HTTPRoute",
            "metadata:",
            "  name: default-dashboard-route",
            "  namespace: default",
            "spec:",
            "  parentRefs:",
            "  - name: opensearch-gateway",
            "  rules:",
            "  - matches:",
            "    - path:",
            "        type: PathPrefix",
            "        value: \\\"/\\\"",
            "    backendRefs:",
            "    - name: opensearch-dashboards",
            "      namespace: opensearch",
            "      port: 5601",
            "EOF",
            "echo Gateway and HTTPRoutes created successfully"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"

    - name: Create NodePort Services
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Creating NodePort services in kube-system namespace..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "cat <<EOF | sudo k3s kubectl apply -f -",
            "apiVersion: v1",
            "kind: Service",
            "metadata:",
            "  name: opensearch-dashboard-nodeport",
            "  namespace: kube-system",
            "spec:",
            "  type: NodePort",
            "  ports:",
            "  - name: https",
            "    port: 443",
            "    targetPort: 8443",
            "    nodePort: 30601",
            "    protocol: TCP",
            "  selector:",
            "    app.kubernetes.io/instance: traefik-kube-system",
            "    app.kubernetes.io/name: traefik",
            "---",
            "apiVersion: v1",
            "kind: Service",
            "metadata:",
            "  name: opensearch-api-nodeport",
            "  namespace: kube-system",
            "spec:",
            "  type: NodePort",
            "  ports:",
            "  - name: https",
            "    port: 443",
            "    targetPort: 8443",
            "    nodePort: 30920",
            "    protocol: TCP",
            "  selector:",
            "    app.kubernetes.io/instance: traefik-kube-system",
            "    app.kubernetes.io/name: traefik",
            "EOF",
            "echo NodePort services created successfully"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"

    - name: Verify Gateway API Setup
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Verifying Gateway API setup..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 300 \
          --parameters 'commands=[
            "echo === Gateway Status ===",
            "sudo k3s kubectl get gateway opensearch-gateway -n default",
            "echo === HTTPRoutes ===", 
            "sudo k3s kubectl get httproute -n default",
            "echo === NodePort Services ===",
            "sudo k3s kubectl get svc opensearch-dashboard-nodeport opensearch-api-nodeport -n kube-system",
            "echo === OpenSearch Services ===",
            "sudo k3s kubectl get svc -n opensearch",
            "echo === Certificates ===",
            "sudo k3s kubectl get certificate -A",
            "echo === Test Health Check (without Host header) ===",
            "curl -k https://localhost:30601/ -I || echo \"Health check test completed\"",
            "echo === Test with Host header ===",
            "curl -k -H \"Host: ${{ vars.OPENSEARCH_DASHBOARD_FQDN }}\" https://localhost:30601/ -I || echo \"Host header test completed\""
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

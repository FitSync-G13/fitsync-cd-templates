name: OpenSearch Helm Deploy

on:
  workflow_call:
    inputs:
      cluster_name:
        description: 'OpenSearch K3s cluster name'
        required: true
        type: string
      master_instances:
        description: 'Comma-separated list of OpenSearch master instance IDs'
        required: true
        type: string
      environment:
        description: 'GitHub environment name'
        required: false
        type: string
        default: 'production'
      opensearch_version:
        description: 'OpenSearch version (leave empty for latest)'
        required: false
        type: string
        default: ''
      opensearch_dashboards_version:
        description: 'OpenSearch Dashboards version (leave empty for latest)'
        required: false
        type: string
        default: ''
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy-opensearch:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION }}
        role-session-name: GitHubActions-OpenSearch-Helm

    - name: Deploy OpenSearch using Helm
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Deploying OpenSearch using official Helm chart..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 1800 \
          --parameters 'commands=[
            "echo Setting up Helm and OpenSearch repository...",
            "curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3",
            "chmod 700 get_helm.sh",
            "./get_helm.sh",
            "sudo k3s kubectl create namespace opensearch --dry-run=client -o yaml | sudo k3s kubectl apply -f -",
            "sudo /usr/local/bin/helm repo add opensearch https://opensearch-project.github.io/helm-charts/ --kubeconfig /etc/rancher/k3s/k3s.yaml",
            "sudo /usr/local/bin/helm repo update --kubeconfig /etc/rancher/k3s/k3s.yaml",
            "echo Checking for existing OpenSearch deployment...",
            "if sudo /usr/local/bin/helm list -n opensearch --kubeconfig /etc/rancher/k3s/k3s.yaml | grep -q opensearch-cluster; then echo OpenSearch already deployed, upgrading...; HELM_ACTION=upgrade; else echo New OpenSearch deployment; HELM_ACTION=install; fi",
            "echo Creating OpenSearch values file...",
            "cat > /tmp/opensearch-values.yaml << \"EOFVALUES\"",
            "image:",
            "  tag: \"${{ inputs.opensearch_version || '2.11.1' }}\"",
            "clusterName: opensearch-cluster",
            "nodeGroup: master",
            "masterService: opensearch-cluster-master", 
            "replicas: '${{ vars.OPENSEARCH_MASTER_COUNT || '1' }}'",
            "roles:",
            "  - master",
            "  - ingest", 
            "  - data",
            "  - remote_cluster_client",
            "resources:",
            "  requests:",
            "    cpu: 1000m",
            "    memory: 2Gi",
            "  limits:",
            "    cpu: 1000m", 
            "    memory: 2Gi",
            "opensearchJavaOpts: -Xmx1g -Xms1g",
            "persistence:",
            "  enabled: true",
            "  storageClass: ebs-sc",
            "  accessModes:",
            "    - ReadWriteOnce",
            "  size: 30Gi",
            "config:",
            "  opensearch.yml: |",
            "    cluster.name: opensearch-cluster",
            "    network.host: 0.0.0.0",
            "    plugins.security.disabled: true",
            "extraEnvs:",
            "  - name: DISABLE_INSTALL_DEMO_CONFIG", 
            "    value: \"true\"",
            "service:",
            "  type: ClusterIP",
            "  httpPort: 9200",
            "  transportPort: 9300",
            "sysctlVmMaxMapCount: 262144",
            "readinessProbe:",
            "  failureThreshold: 3",
            "  periodSeconds: 5", 
            "  timeoutSeconds: 3",
            "  initialDelaySeconds: 60",
            "antiAffinity: soft",
            "EOFVALUES",
            "echo Deploying OpenSearch with Helm...",
            "sudo /usr/local/bin/helm $HELM_ACTION opensearch-cluster opensearch/opensearch --namespace opensearch --values /tmp/opensearch-values.yaml --timeout 20m --kubeconfig /etc/rancher/k3s/k3s.yaml",
            "echo Waiting for OpenSearch pods to be ready...",
            "sudo k3s kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=opensearch-cluster-master -n opensearch --timeout=1200s",
            "echo Verifying OpenSearch cluster health...",
            "sudo k3s kubectl exec -n opensearch opensearch-cluster-master-0 -- curl -XGET http://localhost:9200/_cluster/health",
            "echo OpenSearch cluster deployed successfully using Helm chart"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        OUTPUT=$(aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text)
        
        echo "$OUTPUT"
        
        # Check if deployment was successful
        if echo "$OUTPUT" | grep -q "OpenSearch cluster deployed successfully"; then
          echo "âœ… OpenSearch deployment completed successfully"
        else
          echo "âŒ OpenSearch deployment may have failed"
          # Get error output
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$FIRST_MASTER" \
            --query 'StandardErrorContent' \
            --output text
          exit 1
        fi

    - name: Deploy OpenSearch Dashboards
      if: ${{ vars.OPENSEARCH_DASHBOARDS_ENABLED != 'false' }}
      run: |
        MASTER_INSTANCES="${{ inputs.master_instances }}"
        FIRST_MASTER=$(echo $MASTER_INSTANCES | cut -d',' -f1)
        
        echo "Deploying OpenSearch Dashboards..."
        
        COMMAND_ID=$(aws ssm send-command \
          --instance-ids "$FIRST_MASTER" \
          --document-name "AWS-RunShellScript" \
          --timeout-seconds 600 \
          --parameters 'commands=[
            "echo Creating OpenSearch Dashboards values file...",
            "cat > /tmp/dashboards-values.yaml << \"EOFDASH\"",
            "image:",
            "  tag: \"${{ inputs.opensearch_dashboards_version || '2.11.1' }}\"",
            "opensearchHosts: http://opensearch-cluster-master:9200",
            "replicaCount: 1",
            "resources:",
            "  requests:",
            "    cpu: 100m",
            "    memory: 512Mi",
            "  limits:",
            "    cpu: 500m",
            "    memory: 1Gi",
            "service:",
            "  type: ClusterIP",
            "  port: 5601",
            "config:",
            "  opensearch_dashboards.yml: |",
            "    server.name: opensearch-dashboards",
            "    server.host: 0.0.0.0",
            "    opensearch.hosts: [http://opensearch-cluster-master:9200]",
            "    opensearch.ssl.verificationMode: none",
            "    opensearch_security.multitenancy.enabled: false",
            "    opensearch_security.readonly_mode.roles: []",
            "    opensearch_security.cookie.secure: false",
            "securityContext:",
            "  runAsUser: 1000",
            "  runAsGroup: 1000",
            "  fsGroup: 1000",
            "EOFDASH",
            "echo Checking for existing Dashboards deployment...",
            "if sudo /usr/local/bin/helm list -n opensearch --kubeconfig /etc/rancher/k3s/k3s.yaml | grep -q opensearch-dashboards; then echo OpenSearch Dashboards already deployed, upgrading...; HELM_ACTION=upgrade; else echo New OpenSearch Dashboards deployment; HELM_ACTION=install; fi",
            "echo Deploying OpenSearch Dashboards with Helm...",
            "sudo /usr/local/bin/helm $HELM_ACTION opensearch-dashboards opensearch/opensearch-dashboards --namespace opensearch --values /tmp/dashboards-values.yaml --timeout 10m --kubeconfig /etc/rancher/k3s/k3s.yaml",
            "echo Waiting for Dashboards pods to be ready...",
            "sudo k3s kubectl wait --for=condition=ready pod -l app=opensearch-dashboards -n opensearch --timeout=600s",
            "echo OpenSearch Dashboards deployed successfully"
          ]' \
          --query 'Command.CommandId' \
          --output text)
        
        aws ssm wait command-executed \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER"
        
        aws ssm get-command-invocation \
          --command-id "$COMMAND_ID" \
          --instance-id "$FIRST_MASTER" \
          --query 'StandardOutputContent' \
          --output text

    - name: Store OpenSearch connection details in Secrets Manager
      run: |
        echo "Storing OpenSearch connection details in AWS Secrets Manager..."
        
        # OpenSearch cluster endpoint (internal)
        OPENSEARCH_ENDPOINT="http://opensearch-cluster-master.opensearch.svc.cluster.local:9200"
        
        # OpenSearch Dashboards endpoint (internal)
        DASHBOARDS_ENDPOINT="http://opensearch-dashboards.opensearch.svc.cluster.local:5601"
        
        # Create connection string secret
        CONNECTION_SECRET_NAME="${{ vars.PROJECT_NAME }}/${{ inputs.environment }}/opensearch-connection"
        
        CONNECTION_JSON="{\\\"endpoint\\\": \\\"$OPENSEARCH_ENDPOINT\\\", \\\"dashboards_endpoint\\\": \\\"$DASHBOARDS_ENDPOINT\\\", \\\"security_disabled\\\": true, \\\"namespace\\\": \\\"opensearch\\\", \\\"cluster_name\\\": \\\"opensearch-cluster\\\"}"
        
        if aws secretsmanager describe-secret --secret-id "$CONNECTION_SECRET_NAME" >/dev/null 2>&1; then
          echo "Updating existing connection secret..."
          aws secretsmanager update-secret \
            --secret-id "$CONNECTION_SECRET_NAME" \
            --secret-string "$CONNECTION_JSON"
        else
          echo "Creating new connection secret..."
          aws secretsmanager create-secret \
            --name "$CONNECTION_SECRET_NAME" \
            --description "OpenSearch connection details for ${{ inputs.environment }}" \
            --secret-string "$CONNECTION_JSON" \
            --tags '[{"Key":"Project","Value":"${{ vars.PROJECT_NAME }}"},{"Key":"Environment","Value":"${{ inputs.environment }}"},{"Key":"Service","Value":"opensearch"}]'
        fi
        
        echo "âœ… OpenSearch connection details stored in: $CONNECTION_SECRET_NAME"
        echo ""
        echo "ðŸ“‹ Deployment Summary:"
        echo "  OpenSearch Cluster: opensearch-cluster (namespace: opensearch)"
        echo "  OpenSearch Version: ${{ inputs.opensearch_version || '2.11.1' }}"
        echo "  Dashboards Version: ${{ inputs.opensearch_dashboards_version || '2.11.1' }}"
        echo "  Security Plugin: DISABLED (no authentication required)"
        echo "  Connection Details Secret: $CONNECTION_SECRET_NAME"
        echo "  Internal Endpoint: $OPENSEARCH_ENDPOINT"
        if [ "${{ vars.OPENSEARCH_DASHBOARDS_ENABLED }}" != "false" ]; then
          echo "  Dashboards Endpoint: $DASHBOARDS_ENDPOINT"
        fi
